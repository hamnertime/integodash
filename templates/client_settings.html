{% extends "layout.html" %}
{% block title %}{{ client.name }} Overrides{% endblock %}

{% block head %}
<style>
    h1, h2 { color: #0056b3; }
    h1 { text-align: center; }
    .form-section { background-color: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 30px; }
    .form-grid { display: grid; grid-template-columns: auto 1fr 1fr auto; gap: 15px 20px; align-items: center; }
    .form-grid label { font-weight: bold; text-align: right; }
    .form-grid input[type="number"], .form-grid input[type="text"] { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
    .form-grid .header { font-weight: bold; color: #495057; text-align: center;}
    .form-grid .header.default { grid-column: 2; }
    .form-grid .header.override { grid-column: 3; }
    .form-grid input[type="checkbox"] { justify-self: center; transform: scale(1.2); grid-column: 4; }
    .item-table { width: 100%; margin-top: 15px; }
    .item-table th, .item-table td { padding: 8px; border-bottom: 1px solid #eee; }
    .item-table select, .item-table input { padding: 6px; border-radius: 4px; border: 1px solid #ccc; }
    .button-container { text-align: right; margin-top: 20px; }
    .button-container button { padding: 12px 25px; background-color: #0056b3; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 1.1em; }
</style>
{% endblock %}

{% block content %}
    <h1>Override Settings for {{ client.name }}</h1>

    <form method="POST" action="{{ url_for('client_settings', account_number=client.account_number) }}">
        <div class="form-section">
            <h2>Billing Rate Overrides</h2>
            <div class="form-grid">
                <div></div> <div class="header default">Default Value</div>
                <div class="header override">Override Value</div>
                <div class="header">Enable</div>

                {% macro rate_input(name, label, short_name) %}
                    <label for="{{ name }}">{{ label }}</label>
                    {% if name == 'backup_included_tb' %}
                         <input type="text" value="{{ ('%.2f'|format(defaults[name]) if defaults and defaults[name] is not none else 'N/A') ~ ' TB' }}" disabled>
                    {% elif name == 'prepaid_hours_monthly' or name == 'prepaid_hours_yearly' %}
                        <input type="text" value="{{ defaults[name] if defaults and defaults[name] is not none else '0' }} hours" disabled>
                    {% else %}
                         <input type="text" value="${{ '%.2f'|format(defaults[name]) if defaults and defaults[name] is not none else 'N/A' }}" disabled>
                    {% endif %}
                    <input type="number" step="0.01" name="{{ name }}" id="{{ name }}" value="{{ overrides[name] if overrides and overrides[name] is not none }}">
                    <input type="checkbox" name="override_{{ short_name }}_enabled" {% if overrides and overrides['override_' + short_name + '_enabled'] %}checked{% endif %} title="Enable Override">
                {% endmacro %}

                {{ rate_input('network_management_fee', 'Network Mgmt Fee', 'nmf') }}
                {{ rate_input('per_user_cost', 'Per Regular User Cost', 'puc') }}
                {{ rate_input('per_workstation_cost', 'Per Workstation Cost', 'pwc') }}
                {{ rate_input('per_host_cost', 'Per Server Cost', 'phc') }}
                {{ rate_input('per_vm_cost', 'Per VM Cost', 'pvc') }}
                {{ rate_input('per_switch_cost', 'Per Switch Cost', 'psc') }}
                {{ rate_input('per_firewall_cost', 'Per Firewall Cost', 'pfc') }}
                {{ rate_input('per_hour_ticket_cost', 'Per Hour Ticket Cost', 'phtc')}}
                {{ rate_input('backup_base_fee_workstation', 'Backup Base (Workstation)', 'bbfw') }}
                {{ rate_input('backup_base_fee_server', 'Backup Base (Server)', 'bbfs') }}
                {{ rate_input('backup_included_tb', 'Backup Included (TB)', 'bit') }}
                {{ rate_input('backup_per_tb_fee', 'Backup per TB Fee', 'bpt') }}
                {{ rate_input('prepaid_hours_monthly', 'Pre-paid Hours (Monthly)', 'prepaid_hours_monthly') }}
                {{ rate_input('prepaid_hours_yearly', 'Pre-paid Hours (Yearly)', 'prepaid_hours_yearly') }}
            </div>
        </div>

        <div class="form-section">
            <h2>Asset Billing Overrides</h2>
            <table class="item-table">
                <thead><tr><th>Hostname</th><th>Detected Type</th><th>Billing Type</th><th>Custom Cost ($)</th></tr></thead>
                <tbody>
                {% for asset in assets %}
                    <tr>
                        <td>{{ asset.hostname }}</td>
                        <td>{{ asset.billing_type }}</td>
                        <td>
                            <select name="asset_billing_type_{{ asset.id }}">
                                <option value="" {% if not asset_overrides[asset.id] %}selected{% endif %}>-- Use Detected ({{ asset.billing_type }}) --</option>
                                <option value="Workstation" {% if asset_overrides[asset.id] and asset_overrides[asset.id].billing_type == 'Workstation' %}selected{% endif %}>Workstation</option>
                                <option value="Server" {% if asset_overrides[asset.id] and asset_overrides[asset.id].billing_type == 'Server' %}selected{% endif %}>Server</option>
                                <option value="VM" {% if asset_overrides[asset.id] and asset_overrides[asset.id].billing_type == 'VM' %}selected{% endif %}>VM</option>
                                <option value="No Charge" {% if asset_overrides[asset.id] and asset_overrides[asset.id].billing_type == 'No Charge' %}selected{% endif %}>No Charge</option>
                                <option value="Custom" {% if asset_overrides[asset.id] and asset_overrides[asset.id].billing_type == 'Custom' %}selected{% endif %}>Custom Cost</option>
                            </select>
                        </td>
                        <td><input type="number" step="0.01" name="asset_custom_cost_{{ asset.id }}" placeholder="0.00" value="{{ asset_overrides[asset.id].custom_cost if asset_overrides[asset.id] and asset_overrides[asset.id].custom_cost is not none }}"></td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
            <h3 style="margin-top: 20px;">Manually Added Assets</h3>
             <table class="item-table">
                <tbody>
                {% for asset in manual_assets %}
                    <tr>
                        <td>{{ asset.hostname }}</td>
                        <td>MANUAL</td>
                        <td>{{ asset.billing_type }} {% if asset.billing_type == 'Custom' %}(${{ "%.2f"|format(asset.custom_cost) }}){% endif %}</td>
                        <td><a href="{{ url_for('client_settings', account_number=client.account_number, delete_manual_asset=asset.id) }}" onclick="return confirm('Are you sure?')">Delete</a></td>
                    </tr>
                {% endfor %}
                </tbody>
             </table>
        </div>

        <div class="form-section">
            <h2>User Billing Overrides</h2>
            <table class="item-table">
                <thead><tr><th>Full Name</th><th>Billing Type</th><th>Custom Cost ($)</th></tr></thead>
                <tbody>
                {% for user in users %}
                    <tr>
                        <td>{{ user.full_name }} ({{ user.email }})</td>
                        <td>
                            <select name="user_billing_type_{{ user.id }}">
                                <option value="" {% if not user_overrides[user.id] %}selected{% endif %}>-- Default (Paid) --</option>
                                <option value="Paid" {% if user_overrides[user.id] and user_overrides[user.id].billing_type == 'Paid' %}selected{% endif %}>Paid</option>
                                <option value="No Charge" {% if user_overrides[user.id] and user_overrides[user.id].billing_type == 'No Charge' %}selected{% endif %}>No Charge</option>
                                <option value="Custom" {% if user_overrides[user.id] and user_overrides[user.id].billing_type == 'Custom' %}selected{% endif %}>Custom Cost</option>
                            </select>
                        </td>
                        <td><input type="number" step="0.01" name="user_custom_cost_{{ user.id }}" placeholder="0.00" value="{{ user_overrides[user.id].custom_cost if user_overrides[user.id] and user_overrides[user.id].custom_cost is not none }}"></td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
            <h3 style="margin-top: 20px;">Manually Added Users</h3>
            <table class="item-table">
                <tbody>
                {% for user in manual_users %}
                    <tr>
                        <td>{{ user.full_name }}</td>
                        <td>MANUAL</td>
                        <td>{{ user.billing_type }} {% if user.billing_type == 'Custom' %}(${{ "%.2f"|format(user.custom_cost) }}){% endif %}</td>
                        <td><a href="{{ url_for('client_settings', account_number=client.account_number, delete_manual_user=user.id) }}" onclick="return confirm('Are you sure?')">Delete</a></td>
                    </tr>
                {% endfor %}
                </tbody>
             </table>
        </div>

        <div class="button-container">
            <button type="submit" name="action" value="save_overrides">Save All Overrides</button>
        </div>
    </form>

    <div style="display: flex; gap: 30px; margin-top: 30px;">
        <form method="POST" action="{{ url_for('client_settings', account_number=client.account_number) }}" class="form-section" style="flex: 1;">
            <h2>Add Non-Detected Asset</h2>
            <label>Hostname:</label>
            <input type="text" name="manual_asset_hostname" required>
            <label>Billing Type:</label>
            <select name="manual_asset_billing_type">
                <option value="Workstation">Workstation</option>
                <option value="Server">Server</option>
                <option value="VM">VM</option>
                <option value="No Charge">No Charge</option>
                <option value="Custom">Custom</option>
            </select>
            <label>Custom Cost:</label>
            <input type="number" name="manual_asset_custom_cost" step="0.01">
            <div class="button-container">
                <button type="submit" name="action" value="add_manual_asset">Add Asset</button>
            </div>
        </form>

        <form method="POST" action="{{ url_for('client_settings', account_number=client.account_number) }}" class="form-section" style="flex: 1;">
            <h2>Add Non-Detected User</h2>
            <label>Full Name:</label>
            <input type="text" name="manual_user_name" required>
            <label>Billing Type:</label>
            <select name="manual_user_billing_type">
                <option value="Paid">Paid</option>
                <option value="No Charge">No Charge</option>
                <option value="Custom">Custom</option>
            </select>
            <label>Custom Cost:</label>
            <input type="number" name="manual_user_custom_cost" step="0.01">
            <div class="button-container">
                <button type="submit" name="action" value="add_manual_user">Add User</button>
            </div>
        </form>
    </div>
{% endblock %}
