{% extends "layout.html" %}
{% block title %}{{ client.name }} Overrides{% endblock %}

{% block head %}
{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Override Settings for {{ client.name }}</h1>
    <button id="restore-layout-btn" class="button">Restore Default Layout</button>
</div>
<form method="POST" action="{{ url_for('clients.client_settings', account_number=client.account_number) }}">
    <div class="grid-stack">
        <div class="grid-stack-item" gs-id="client-details-widget" gs-w="6" gs-h="4">
            <div class="grid-stack-item-content form-section">
                <h2>Client Details</h2>
                <div class="form-grid" style="grid-template-columns: auto 1fr;">
                    <label for="account_number">Account Number</label>
                    <input type="text" id="account_number" value="{{ client.account_number or '' }}" readonly>

                    <label for="company_owner">Company Owner</label>
                    <input type="text" name="company_owner" id="company_owner" value="{{ client.company_owner or '' }}">

                    <label for="phone_number">Phone Number</label>
                    <input type="text" name="phone_number" id="phone_number" value="{{ client.phone_number or '' }}">

                    <label for="domains">Domains</label>
                    <input type="text" name="domains" id="domains" value="{{ client.domains or '' }}">

                    <label for="business_type">Business Type</label>
                    <select name="business_type" id="business_type">
                        <option value="For Profit" {% if client.business_type == 'For Profit' %}selected{% endif %}>For Profit</option>
                        <option value="Non-Profit" {% if client.business_type == 'Non-Profit' %}selected{% endif %}>Non-Profit</option>
                    </select>

                    <label for="description">Description</label>
                    <textarea name="description" id="description" rows="4" style="grid-column: 1 / span 2;">{{ client.description or '' }}</textarea>
                </div>
            </div>
        </div>
        <div class="grid-stack-item" gs-id="contract-details-widget" gs-x="6" gs-w="6" gs-h="3">
            <div class="grid-stack-item-content form-section">
                <h2>Contract Details</h2>
                <div class="form-grid" style="grid-template-columns: auto 1fr;">
                    <label for="client_start_date">Client Start Date</label>
                    <input type="date" name="client_start_date" id="client_start_date" value="{{ client.client_start_date or '' }}">

                    <label for="contract_term_length">Contract Term</label>
                    <select name="contract_term_length" id="contract_term_length">
                        <option value="Month to Month" {% if client.contract_term_length == 'Month to Month' %}selected{% endif %}>Month to Month</option>
                        <option value="1-Year" {% if client.contract_term_length == '1-Year' %}selected{% endif %}>1-Year</option>
                        <option value="2-Year" {% if client.contract_term_length == '2-Year' %}selected{% endif %}>2-Year</option>
                        <option value="3-Year" {% if client.contract_term_length == '3-Year' %}selected{% endif %}>3-Year</option>
                    </select>

                    <label for="contract_start_date">Contract Start Date</label>
                    <input type="date" name="contract_start_date" id="contract_start_date" value="{{ client.contract_start_date or '' }}">
                </div>
            </div>
        </div>
        <div class="grid-stack-item" gs-id="locations-settings-widget" gs-y="7" gs-w="12" gs-h="4">
            <div class="grid-stack-item-content form-section">
                <h2>Locations</h2>
                <table class="item-table">
                    <thead>
                        <tr>
                            <th>Location Name</th>
                            <th>Address</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for location in locations %}
                        <tr>
                            <td>{{ location.location_name }}</td>
                            <td>{{ location.address }}</td>
                            <td>
                                <button type="button" class="icon-button edit edit-location"
                                    data-location-id="{{ location.id }}"
                                    data-location-name="{{ location.location_name }}"
                                    data-address="{{ location.address }}">
                                    <svg viewBox="0 0 24 24"><path d="M20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18,2.9 17.35,2.9 16.96,3.29L15.13,5.12L18.88,8.87M3,17.25V21H6.75L17.81,9.94L14.06,6.19L3,17.25Z" /></svg>
                                </button>
                                <a href="{{ url_for('clients.client_settings', account_number=client.account_number, delete_location=location.id) }}" class="icon-button delete" onclick="return confirm('Are you sure?')">
                                    <svg viewBox="0 0 24 24"><path d="M9,3V4H4V6H5V19C5,20.1 5.9,21 7,21H17C18.1,21 19,20.1 19,19V6H20V4H15V3H9M7,6H17V19H7V6M9,8V17H11V8H9M13,8V17H15V8H13Z" /></svg>
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                <div class="add-plan-form full-width" style="margin-top: 20px;">
                    <input type="text" name="location_name" placeholder="New Location Name">
                    <input type="text" name="address" placeholder="Address">
                    <button type="submit" name="action" value="add_location">Add Location</button>
                </div>
            </div>
        </div>

        <div class="grid-stack-item" gs-id="billing-overrides-widget" gs-y="4" gs-w="12" gs-h="6">
            <div class="grid-stack-item-content form-section">
                <h2>Billing Rate Overrides</h2>
                <div class="form-grid">
                    <div></div> <div class="header default">Default Value</div>
                    <div class="header override">Override Value</div>
                    <div class="header">Enable</div>

                    {% macro plan_override_input(name, label, short_name, all_plans) %}
                        <label for="{{ name }}">{{ label }}</label>
                        <input type="text" value="{{ client.billing_plan or 'N/A' }}" disabled>
                        <select name="{{ name }}" id="{{ name }}">
                             <option value="">-- No Override --</option>
                             {% for plan in all_plans %}
                                 <option value="{{ plan.billing_plan }}" {% if overrides and name in overrides and overrides[name] == plan.billing_plan %}selected{% endif %}>{{ plan.billing_plan }}</option>
                             {% endfor %}
                        </select>
                        <input type="checkbox" name="override_{{ short_name }}_enabled" {% if overrides and ('override_' + short_name + '_enabled') in overrides and overrides['override_' + short_name + '_enabled'] %}checked{% endif %} title="Enable Override">
                    {% endmacro %}

                    {% macro rate_input(name, label, short_name, type='currency', step='0.01') %}
                        <label for="{{ name }}">{{ label }}</label>
                        {% if type == 'text' %}
                            <input type="text" value="{{ defaults[name] if defaults and name in defaults.keys() and defaults[name] is not none else 'N/A' }}" disabled>
                            <select name="{{ name }}" id="{{ name }}">
                                 <option value="">-- No Override --</option>
                                 <option value="Billed Hourly" {% if overrides and name in overrides and overrides[name] == 'Billed Hourly' %}selected{% endif %}>Billed Hourly</option>
                                 <option value="Unlimited" {% if overrides and name in overrides and overrides[name] == 'Unlimited' %}selected{% endif %}>Unlimited</option>
                            </select>
                        {% elif type == 'number' %}
                             <input type="text" value="{{ defaults[name] if defaults and name in defaults.keys() and defaults[name] is not none else '0' }}" disabled>
                             <input type="number" step="{{ step }}" name="{{ name }}" id="{{ name }}" value="{{ overrides[name] if overrides and name in overrides and overrides[name] is not none }}">
                        {% else %}
                            <input type="text" value="${{ '%.2f'|format(defaults[name]|float) if defaults and name in defaults.keys() and defaults[name] is not none else 'N/A' }}" disabled>
                            <input type="number" step="{{ step }}" name="{{ name }}" id="{{ name }}" value="{{ overrides[name] if overrides and name in overrides and overrides[name] is not none }}">
                        {% endif %}
                        <input type="checkbox" name="override_{{ short_name }}_enabled" {% if overrides and ('override_' + short_name + '_enabled') in overrides and overrides['override_' + short_name + '_enabled'] %}checked{% endif %} title="Enable Override">
                    {% endmacro %}

                    {{ plan_override_input('billing_plan', 'Assigned Plan', 'billing_plan', all_billing_plans) }}
                    {{ rate_input('support_level', 'Support Level', 'support_level', type='text') }}
                    {{ rate_input('per_user_cost', 'Per Regular User Cost', 'puc') }}
                    {{ rate_input('per_workstation_cost', 'Per Workstation Cost', 'pwc') }}
                    {{ rate_input('per_server_cost', 'Per Server Cost', 'psc') }}
                    {{ rate_input('per_vm_cost', 'Per VM Cost', 'pvc') }}
                    {{ rate_input('per_switch_cost', 'Per Switch Cost', 'pswitchc') }}
                    {{ rate_input('per_firewall_cost', 'Per Firewall Cost', 'pfirewallc') }}
                    {{ rate_input('per_hour_ticket_cost', 'Per Hour Ticket Cost', 'phtc')}}
                    {{ rate_input('backup_base_fee_workstation', 'Backup Base (Workstation)', 'bbfw') }}
                    {{ rate_input('backup_base_fee_server', 'Backup Base (Server)', 'bbfs') }}
                    {{ rate_input('backup_included_tb', 'Backup Included (TB)', 'bit', type='number') }}
                    {{ rate_input('backup_per_tb_fee', 'Backup per TB Fee', 'bpt') }}
                    {{ rate_input('prepaid_hours_monthly', 'Pre-paid Hours (Monthly)', 'prepaid_hours_monthly', type='number', step='1') }}
                    {{ rate_input('prepaid_hours_yearly', 'Pre-paid Hours (Yearly)', 'prepaid_hours_yearly', type='number', step='1') }}
                </div>
            </div>
        </div>

        <div class="grid-stack-item" gs-id="feature-overrides-widget" gs-y="10" gs-w="12" gs-h="5">
            <div class="grid-stack-item-content form-section">
                <h2>Feature Overrides</h2>
                <div class="form-grid">
                    <div></div>
                    <div class="header default">Default Value</div>
                    <div class="header override">Override Value</div>
                    <div class="header">Enable</div>

                    {% for feature_type, options in feature_options.items() %}
                        {% set name = 'feature_' + feature_type.lower().replace(' ', '_') %}
                        {% set short_name = feature_type.lower().replace(' ', '_') %}
                        <label>{{ feature_type }}</label>
                        <input type="text" value="{{ defaults[name] if defaults and name in defaults.keys() else 'Not Included' }}" disabled>
                        <select name="{{ name }}">
                            <option value="">-- No Override --</option>
                            {% for option in options %}
                            <option value="{{ option.option_name }}" {% if overrides and name in overrides and overrides[name] == option.option_name %}selected{% endif %}>{{ option.option_name }}</option>
                            {% endfor %}
                        </select>
                        <input type="checkbox" name="override_feature_{{ short_name }}_enabled" {% if overrides and ('override_feature_' + short_name + '_enabled') in overrides and overrides['override_feature_' + short_name + '_enabled'] %}checked{% endif %} title="Enable Override">
                    {% endfor %}
                </div>
            </div>
        </div>

        <div class="grid-stack-item" gs-id="asset-overrides-widget" gs-y="15" gs-w="12" gs-h="6">
            <div class="grid-stack-item-content form-section">
                <h2>Asset Billing Overrides</h2>
                <table class="item-table">
                    <thead><tr><th>Hostname</th><th>Associated Contacts</th><th>Detected Type</th><th>Billing Type</th><th>Custom Cost ($)</th></tr></thead>
                    <tbody>
                    {% for asset in assets %}
                        <tr>
                            <td>{{ asset.hostname }}</td>
                            <td>{{ asset.associated_contacts }}</td>
                            <td>{{ asset.billing_type }}</td>
                            <td>
                                <select name="asset_billing_type_{{ asset.id }}">
                                    <option value="" {% if not asset_overrides[asset.id] %}selected{% endif %}>-- Use Detected ({{ asset.billing_type }}) --</option>
                                    <option value="Workstation" {% if asset_overrides[asset.id] and asset_overrides[asset.id].billing_type == 'Workstation' %}selected{% endif %}>Workstation</option>
                                    <option value="Server" {% if asset_overrides[asset.id] and asset_overrides[asset.id].billing_type == 'Server' %}selected{% endif %}>Server</option>
                                    <option value="VM" {% if asset_overrides[asset.id] and asset_overrides[asset.id].billing_type == 'VM' %}selected{% endif %}>VM</option>
                                    <option value="No Charge" {% if asset_overrides[asset.id] and asset_overrides[asset.id].billing_type == 'No Charge' %}selected{% endif %}>No Charge</option>
                                    <option value="Custom" {% if asset_overrides[asset.id] and asset_overrides[asset.id].billing_type == 'Custom' %}selected{% endif %}>Custom Cost</option>
                                </select>
                            </td>
                            <td><input type="number" step="0.01" name="asset_custom_cost_{{ asset.id }}" placeholder="0.00" value="{{ asset_overrides[asset.id].custom_cost if asset_overrides[asset.id] and asset_overrides[asset.id].custom_cost is not none }}"></td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
                <h3 style="margin-top: 20px;">Manually Added Assets</h3>
                 <table class="item-table">
                    <thead><tr><th>Hostname</th><th>Source</th><th>Billing Type</th><th>Cost</th><th>Actions</th></tr></thead>
                    <tbody>
                    {% for asset in manual_assets %}
                        <tr>
                            <td>{{ asset.hostname }}</td>
                            <td>MANUAL</td>
                            <td>{{ asset.billing_type }}</td>
                            <td>${{ "%.2f"|format(asset.custom_cost|float) if asset.custom_cost is not none else '0.00' }}</td>
                            <td>
                                 <button type="button" class="icon-button edit edit-manual-asset"
                                    data-asset-id="{{ asset.id }}"
                                    data-hostname="{{ asset.hostname }}"
                                    data-billing-type="{{ asset.billing_type }}"
                                    data-custom-cost="{{ asset.custom_cost if asset.custom_cost is not none else '' }}">
                                    <svg viewBox="0 0 24 24"><path d="M20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18,2.9 17.35,2.9 16.96,3.29L15.13,5.12L18.88,8.87M3,17.25V21H6.75L17.81,9.94L14.06,6.19L3,17.25Z" /></svg>
                                </button>
                                <a href="{{ url_for('clients.client_settings', account_number=client.account_number, delete_manual_asset=asset.id) }}" class="icon-button delete" onclick="return confirm('Are you sure?')">
                                    <svg viewBox="0 0 24 24"><path d="M9,3V4H4V6H5V19C5,20.1 5.9,21 7,21H17C18.1,21 19,20.1 19,19V6H20V4H15V3H9M7,6H17V19H7V6M9,8V17H11V8H9M13,8V17H15V8H13Z" /></svg>
                                </a>
                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                 </table>
            </div>
        </div>

        <div class="grid-stack-item" gs-id="user-overrides-widget" gs-y="21" gs-w="12" gs-h="6">
            <div class="grid-stack-item-content form-section">
                <h2>User Billing Overrides</h2>
                <table class="item-table">
                    <thead><tr><th>Full Name</th><th>Associated Assets</th><th>Employment Type</th><th>Billing Type</th><th>Custom Cost ($)</th></tr></thead>
                    <tbody>
                    {% for user in users %}
                        <tr>
                            <td>{{ user.full_name }} ({{ user.email }})</td>
                            <td>
                                {% if user.associated_assets %}
                                    {% set assets = user.associated_assets | fromjson %}
                                    {% for asset in assets %}
                                        {% if asset.hostname %}
                                            {% if asset.portal_url %}
                                                <a href="{{ asset.portal_url }}" target="_blank">{{ asset.hostname }}</a>
                                            {% else %}
                                                {{ asset.hostname }}
                                            {% endif %}
                                            {% if not loop.last %}, {% endif %}
                                        {% endif %}
                                    {% endfor %}
                                {% endif %}
                            </td>
                            <td>
                                <select name="user_employment_type_{{ user.id }}">
                                    <option value="" {% if not user_overrides[user.id] or not user_overrides[user.id].employment_type %}selected{% endif %}>-- Default ({{ user.default_employment_type or 'Full Time' }}) --</option>
                                    <option value="Full Time" {% if user_overrides[user.id] and user_overrides[user.id].employment_type == 'Full Time' %}selected{% endif %}>Full Time</option>
                                    <option value="Part Time" {% if user_overrides[user.id] and user_overrides[user.id].employment_type == 'Part Time' %}selected{% endif %}>Part Time</option>
                                </select>
                            </td>
                            <td>
                                <select name="user_billing_type_{{ user.id }}">
                                    <option value="" {% if not user_overrides[user.id] %}selected{% endif %}>-- Default (Paid) --</option>
                                    <option value="Paid" {% if user_overrides[user.id] and user_overrides[user.id].billing_type == 'Paid' %}selected{% endif %}>Paid</option>
                                    <option value="No Charge" {% if user_overrides[user.id] and user_overrides[user.id].billing_type == 'No Charge' %}selected{% endif %}>No Charge</option>
                                    <option value="Custom" {% if user_overrides[user.id] and user_overrides[user.id].billing_type == 'Custom' %}selected{% endif %}>Custom Cost</option>
                                </select>
                            </td>
                            <td><input type="number" step="0.01" name="user_custom_cost_{{ user.id }}" placeholder="0.00" value="{{ user_overrides[user.id].custom_cost if user_overrides[user.id] and user_overrides[user.id].custom_cost is not none }}"></td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
                <h3 style="margin-top: 20px;">Manually Added Users</h3>
                <table class="item-table">
                     <thead><tr><th>Full Name</th><th>Source</th><th>Billing Type</th><th>Cost</th><th>Actions</th></tr></thead>
                    <tbody>
                    {% for user in manual_users %}
                        <tr>
                            <td>{{ user.full_name }}</td>
                            <td>MANUAL</td>
                            <td>{{ user.billing_type }}</td>
                            <td>${{ "%.2f"|format(user.custom_cost|float) if user.custom_cost is not none else '0.00' }}</td>
                            <td>
                                <button type="button" class="icon-button edit edit-manual-user"
                                    data-user-id="{{ user.id }}"
                                    data-full-name="{{ user.full_name }}"
                                    data-billing-type="{{ user.billing_type }}"
                                    data-custom-cost="{{ user.custom_cost if user.custom_cost is not none else '' }}">
                                    <svg viewBox="0 0 24 24"><path d="M20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18,2.9 17.35,2.9 16.96,3.29L15.13,5.12L18.88,8.87M3,17.25V21H6.75L17.81,9.94L14.06,6.19L3,17.25Z" /></svg>
                                </button>
                                 <a href="{{ url_for('clients.client_settings', account_number=client.account_number, delete_manual_user=user.id) }}" class="icon-button delete" onclick="return confirm('Are you sure?')">
                                    <svg viewBox="0 0 24 24"><path d="M9,3V4H4V6H5V19C5,20.1 5.9,21 7,21H17C18.1,21 19,20.1 19,19V6H20V4H15V3H9M7,6H17V19H7V6M9,8V17H11V8H9M13,8V17H15V8H13Z" /></svg>
                                </a>
                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                 </table>
            </div>
        </div>

        <div class="grid-stack-item" gs-id="add-manual-asset-widget" gs-y="27" gs-w="6" gs-h="3">
            <div class="grid-stack-item-content form-section simple-form" style="flex: 1;">
                <h2>Add Manual Asset</h2>
                <div class="form-row">
                    <div>
                        <label for="manual_asset_hostname">Hostname:</label>
                        <input type="text" id="manual_asset_hostname" name="manual_asset_hostname">
                    </div>
                    <div>
                        <label for="manual_asset_custom_cost">Custom Cost:</label>
                        <input type="number" id="manual_asset_custom_cost" name="manual_asset_custom_cost" step="0.01">
                    </div>
                </div>
                <div>
                    <label for="manual_asset_billing_type">Billing Type:</label>
                    <select id="manual_asset_billing_type" name="manual_asset_billing_type">
                        <option value="Workstation">Workstation</option>
                        <option value="Server">Server</option>
                        <option value="VM">VM</option>
                        <option value="No Charge">No Charge</option>
                        <option value="Custom">Custom</option>
                    </select>
                </div>
                <div class="button-container">
                    <button type="submit" name="action" value="add_manual_asset">Add Asset</button>
                </div>
            </div>
        </div>

        <div class="grid-stack-item" gs-id="add-manual-user-widget" gs-x="6" gs-y="27" gs-w="6" gs-h="3">
            <div class="grid-stack-item-content form-section simple-form" style="flex: 1;">
                <h2>Add Manual User</h2>
                <div class="form-row">
                    <div>
                        <label for="manual_user_name">Full Name:</label>
                        <input type="text" id="manual_user_name" name="manual_user_name">
                    </div>
                    <div>
                        <label for="manual_user_custom_cost">Custom Cost:</label>
                        <input type="number" id="manual_user_custom_cost" name="manual_user_custom_cost" step="0.01">
                    </div>
                </div>
                <div>
                    <label for="manual_user_billing_type">Billing Type:</label>
                    <select id="manual_user_billing_type" name="manual_user_billing_type">
                        <option value="Paid">Paid</option>
                        <option value="No Charge">No Charge</option>
                        <option value="Custom">Custom</option>
                    </select>
                </div>
                <div class="button-container">
                    <button type="submit" name="action" value="add_manual_user">Add User</button>
                </div>
            </div>
        </div>

        <div class="grid-stack-item" gs-id="custom-line-items-widget" gs-y="30" gs-w="12" gs-h="5">
            <div class="grid-stack-item-content form-section simple-form">
                <h2>Custom Line Items</h2>
                <table class="item-table">
                    <thead><tr><th>Name</th><th>Type</th><th>Amount</th><th>Billing Period</th><th>Actions</th></tr></thead>
                    <tbody>
                    {% for item in custom_line_items %}
                        <tr>
                            <td>{{ item.name }}</td>
                            <td>
                                {% if item.monthly_fee is not none %}Recurring
                                {% elif item.yearly_fee is not none %}Yearly
                                {% else %}One-Off{% endif %}
                            </td>
                            <td>${{ "%.2f"|format(item.monthly_fee or item.one_off_fee or item.yearly_fee or 0.0) }}</td>
                            <td>
                                {% if item.one_off_year %}{{ item.one_off_year }}-{{ "%02d"|format(item.one_off_month) }}
                                {% elif item.yearly_bill_month %}Every {{ "%02d"|format(item.yearly_bill_month) }}/{{ "%02d"|format(item.yearly_bill_day) }}
                                {% else %}N/A{% endif %}
                            </td>
                            <td>
                                <button type="button" class="icon-button edit edit-line-item"
                                    data-item-id="{{ item.id }}"
                                    data-name="{{ item.name }}"
                                    data-monthly-fee="{{ item.monthly_fee if item.monthly_fee is not none else '' }}"
                                    data-one-off-fee="{{ item.one_off_fee if item.one_off_fee is not none else '' }}"
                                    data-one-off-month="{{ item.one_off_month if item.one_off_month is not none else '' }}"
                                    data-one-off-year="{{ item.one_off_year if item.one_off_year is not none else '' }}"
                                    data-yearly-fee="{{ item.yearly_fee if item.yearly_fee is not none else '' }}"
                                    data-yearly-bill-month="{{ item.yearly_bill_month if item.yearly_bill_month is not none else '' }}"
                                    data-yearly-bill-day="{{ item.yearly_bill_day if item.yearly_bill_day is not none else '' }}"
                                >
                                    <svg viewBox="0 0 24 24"><path d="M20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18,2.9 17.35,2.9 16.96,3.29L15.13,5.12L18.88,8.87M3,17.25V21H6.75L17.81,9.94L14.06,6.19L3,17.25Z" /></svg>
                                </button>
                                <a href="{{ url_for('clients.client_settings', account_number=client.account_number, delete_line_item=item.id) }}" class="icon-button delete" onclick="return confirm('Are you sure?')">
                                    <svg viewBox="0 0 24 24"><path d="M9,3V4H4V6H5V19C5,20.1 5.9,21 7,21H17C18.1,21 19,20.1 19,19V6H20V4H15V3H9M7,6H17V19H7V6M9,8V17H11V8H9M13,8V17H15V8H13Z" /></svg>
                                </a>
                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>

                <h3 style="margin-top: 20px;">Add New Line Item</h3>
                 <div class="form-row">
                    <div>
                        <label for="line_item_name">Item Name:</label>
                        <input type="text" id="line_item_name" name="line_item_name">
                    </div>
                    <div id="recurring_fields">
                        <label for="line_item_recurring_fee">Monthly Fee:</label>
                        <input type="number" id="line_item_recurring_fee" name="line_item_recurring_fee" step="0.01">
                    </div>
                </div>
                <div>
                    <label for="line_item_type">Item Type:</label>
                    <select id="line_item_type" name="line_item_type">
                        <option value="recurring" selected>Recurring Monthly</option>
                        <option value="one_off">One-Off Charge</option>
                        <option value="yearly">Recurring Yearly</option>
                    </select>
                </div>

                <div id="one_off_fields" style="display:none;">
                    <label for="line_item_one_off_fee">One-Off Fee:</label>
                    <input type="number" id="line_item_one_off_fee" name="line_item_one_off_fee" step="0.01">
                    <label for="line_item_one_off_month">Billing Month:</label>
                    <select id="line_item_one_off_month" name="line_item_one_off_month">
                        {% for month in month_options %}
                            <option value="{{ month.value }}">{{ month.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div id="yearly_fields" style="display:none;">
                    <label for="line_item_yearly_fee">Yearly Fee:</label>
                    <input type="number" id="line_item_yearly_fee" name="line_item_yearly_fee" step="0.01">
                    <label for="line_item_yearly_month">Billing Month:</label>
                    <select id="line_item_yearly_month" name="line_item_yearly_month">
                        {% for i in range(1, 13) %}<option value="{{ i }}">{{ i }}</option>{% endfor %}
                    </select>
                    <label for="line_item_yearly_day">Billing Day:</label>
                    <select id="line_item_yearly_day" name="line_item_yearly_day">
                        {% for i in range(1, 32) %}<option value="{{ i }}">{{ i }}</option>{% endfor %}
                    </select>
                </div>

                <div class="button-container">
                    <button type="submit" name="action" value="add_line_item">Add Line Item</button>
                </div>
            </div>
        </div>
    </div>
    <div class="button-container" style="text-align: right; margin-top: 20px; padding-right: 20px;">
        <button type="submit" name="action" value="save_overrides" class="button">Save All Settings</button>
    </div>
</form>

    <div id="manualAssetModal" class="modal">
        <div class="modal-content simple-form">
            <div class="modal-header">
                <h2 id="manualAssetModalTitle">Edit Manual Asset</h2>
                <span class="close-button">&times;</span>
            </div>
            <form id="manualAssetModalForm" method="POST">
                <div class="form-row">
                    <div>
                        <label for="manualAssetHostname">Hostname:</label>
                        <input type="text" name="hostname" id="manualAssetHostname" required>
                    </div>
                    <div>
                        <label for="manualAssetCustomCost">Custom Cost:</label>
                        <input type="number" name="custom_cost" id="manualAssetCustomCost" step="0.01">
                    </div>
                </div>
                <div>
                    <label for="manualAssetBillingType">Billing Type:</label>
                    <select name="billing_type" id="manualAssetBillingType">
                        <option value="Workstation">Workstation</option>
                        <option value="Server">Server</option>
                        <option value="VM">VM</option>
                        <option value="No Charge">No Charge</option>
                        <option value="Custom">Custom</option>
                    </select>
                </div>
                <div class="button-container">
                    <button type="submit">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <div id="manualUserModal" class="modal">
        <div class="modal-content simple-form">
            <div class="modal-header">
                <h2 id="manualUserModalTitle">Edit Manual User</h2>
                <span class="close-button">&times;</span>
            </div>
            <form id="manualUserModalForm" method="POST">
                 <div class="form-row">
                    <div>
                        <label for="manualUserFullName">Full Name:</label>
                        <input type="text" name="full_name" id="manualUserFullName" required>
                    </div>
                    <div>
                        <label for="manualUserCustomCost">Custom Cost:</label>
                        <input type="number" name="custom_cost" id="manualUserCustomCost" step="0.01">
                    </div>
                </div>
                <div>
                    <label for="manualUserBillingType">Billing Type:</label>
                    <select name="billing_type" id="manualUserBillingType">
                        <option value="Paid">Paid</option>
                        <option value="No Charge">No Charge</option>
                        <option value="Custom">Custom</option>
                    </select>
                </div>
                <div class="button-container">
                    <button type="submit">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <div id="lineItemModal" class="modal">
        <div class="modal-content simple-form">
            <div class="modal-header">
                <h2 id="lineItemModalTitle">Edit Line Item</h2>
                <span class="close-button">&times;</span>
            </div>
            <form id="lineItemModalForm" method="POST">
                </form>
        </div>
    </div>

    <div id="locationModal" class="modal">
        <div class="modal-content simple-form">
            <div class="modal-header">
                <h2 id="locationModalTitle">Edit Location</h2>
                <span class="close-button">&times;</span>
            </div>
            <form id="locationModalForm" method="POST">
                <div class="form-row">
                    <div>
                        <label for="locationName">Location Name:</label>
                        <input type="text" name="location_name" id="locationName" required>
                    </div>
                    <div>
                        <label for="locationAddress">Address:</label>
                        <input type="text" name="address" id="locationAddress">
                    </div>
                </div>
                <div class="button-container">
                    <button type="submit">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    initializeGrid(
        'client_settings',
        {{ layout|tojson|safe }},
        {{ default_layout|tojson|safe }}
    );

    function toggleLineItemFields(itemType) {
        // Find the correct elements relative to the select element
        const formSection = document.querySelector('#custom-line-items-widget .grid-stack-item-content');
        const recurringFields = formSection.querySelector('#recurring_fields');
        const oneOffFields = formSection.querySelector('#one_off_fields');
        const yearlyFields = formSection.querySelector('#yearly_fields');

        recurringFields.style.display = 'none';
        oneOffFields.style.display = 'none';
        yearlyFields.style.display = 'none';

        if (itemType === 'recurring') {
            recurringFields.style.display = 'block';
        } else if (itemType === 'one_off') {
            oneOffFields.style.display = 'block';
        } else if (itemType === 'yearly') {
            yearlyFields.style.display = 'block';
        }
    }

    const lineItemTypeSelect = document.getElementById('line_item_type');
    if (lineItemTypeSelect) {
        // Initialize the view
        toggleLineItemFields(lineItemTypeSelect.value);
        // Add event listener
        lineItemTypeSelect.addEventListener('change', (e) => toggleLineItemFields(e.target.value));
    }


    const manualAssetModal = document.getElementById('manualAssetModal');
    const manualUserModal = document.getElementById('manualUserModal');
    const lineItemModal = document.getElementById('lineItemModal');
    const locationModal = document.getElementById('locationModal');
    const widgetLibraryModal = document.getElementById('widgetLibraryModal');
    const closeButtons = document.querySelectorAll('.close-button');

    function closeModal() {
        if(manualAssetModal) manualAssetModal.style.display = 'none';
        if(manualUserModal) manualUserModal.style.display = 'none';
        if(lineItemModal) lineItemModal.style.display = 'none';
        if(locationModal) locationModal.style.display = 'none';
        if(widgetLibraryModal) widgetLibraryModal.style.display = 'none';
    }

    closeButtons.forEach(button => {
        button.onclick = closeModal;
    });

    window.onclick = (event) => {
        if (event.target == manualAssetModal || event.target == manualUserModal || event.target == lineItemModal || event.target == locationModal || event.target == widgetLibraryModal) {
            closeModal();
        }
    }

    document.querySelectorAll('.edit-manual-asset').forEach(button => {
        button.addEventListener('click', function() {
            const assetId = this.dataset.assetId;
            document.getElementById('manualAssetModalForm').action = `{{ url_for('clients.edit_manual_asset', account_number=client.account_number, asset_id=0) }}`.replace('0', assetId);
            document.getElementById('manualAssetHostname').value = this.dataset.hostname;
            document.getElementById('manualAssetBillingType').value = this.dataset.billingType;
            document.getElementById('manualAssetCustomCost').value = this.dataset.customCost;
            manualAssetModal.style.display = 'block';
        });
    });

    document.querySelectorAll('.edit-manual-user').forEach(button => {
        button.addEventListener('click', function() {
            const userId = this.dataset.userId;
            document.getElementById('manualUserModalForm').action = `{{ url_for('clients.edit_manual_user', account_number=client.account_number, user_id=0) }}`.replace('0', userId);
            document.getElementById('manualUserFullName').value = this.dataset.fullName;
            document.getElementById('manualUserBillingType').value = this.dataset.billingType;
            document.getElementById('manualUserCustomCost').value = this.dataset.customCost;
            manualUserModal.style.display = 'block';
        });
    });

    document.querySelectorAll('.edit-location').forEach(button => {
        button.addEventListener('click', function() {
            const locationId = this.dataset.locationId;
            document.getElementById('locationModalForm').action = `{{ url_for('clients.edit_location', account_number=client.account_number, location_id=0) }}`.replace('0', locationId);
            document.getElementById('locationName').value = this.dataset.locationName;
            document.getElementById('locationAddress').value = this.dataset.address;
            locationModal.style.display = 'block';
        });
    });

    document.querySelectorAll('.edit-line-item').forEach(button => {
        button.addEventListener('click', function(event) {
            event.preventDefault(); // Prevent the default link behavior
            const itemId = this.dataset.itemId;
            const form = document.getElementById('lineItemModalForm');
            form.action = `{{ url_for('clients.edit_line_item', account_number=client.account_number, item_id=0) }}`.replace('0', itemId);

            // Determine item type
            let itemType = 'recurring';
            if (this.dataset.oneOffFee) {
                itemType = 'one_off';
            } else if (this.dataset.yearlyFee) {
                itemType = 'yearly';
            }

            // Populate the modal form dynamically
            let formContent = `
                <label for="modal_line_item_name">Item Name:</label>
                <input type="text" id="modal_line_item_name" name="line_item_name" value="${this.dataset.name}" required>

                <label for="modal_line_item_type">Item Type:</label>
                <select id="modal_line_item_type" name="line_item_type">
                    <option value="recurring" ${itemType === 'recurring' ? 'selected' : ''}>Recurring Monthly</option>
                    <option value="one_off" ${itemType === 'one_off' ? 'selected' : ''}>One-Off Charge</option>
                    <option value="yearly" ${itemType === 'yearly' ? 'selected' : ''}>Recurring Yearly</option>
                </select>

                <div id="modal_recurring_fields" style="display: ${itemType === 'recurring' ? 'block' : 'none'};">
                    <label>Monthly Fee:</label>
                    <input type="number" name="line_item_recurring_fee" step="0.01" value="${this.dataset.monthlyFee || ''}">
                </div>

                <div id="modal_one_off_fields" style="display: ${itemType === 'one_off' ? 'block' : 'none'};">
                    <label>One-Off Fee:</label>
                    <input type="number" name="line_item_one_off_fee" step="0.01" value="${this.dataset.oneOffFee || ''}">
                    <label>Billing Month:</label>
                    <select name="line_item_one_off_month">
                        {% for month in month_options %}
                            <option value="{{ month.value }}" ${this.dataset.oneOffYear && this.dataset.oneOffMonth && '{{ month.value }}' === `${this.dataset.oneOffYear}-${this.dataset.oneOffMonth.padStart(2, '0')}` ? 'selected' : ''}>
                                {{ month.name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <div id="modal_yearly_fields" style="display: ${itemType === 'yearly' ? 'block' : 'none'};">
                    <label>Yearly Fee:</label>
                    <input type="number" name="line_item_yearly_fee" step="0.01" value="${this.dataset.yearlyFee || ''}">
                    <label>Billing Month:</label>
                    <select name="line_item_yearly_month">
                        ${[...Array(12).keys()].map(i => `<option value="${i+1}" ${this.dataset.yearlyBillMonth == i+1 ? 'selected' : ''}>${i+1}</option>`).join('')}
                    </select>
                    <label>Billing Day:</label>
                    <select name="line_item_yearly_day">
                        ${[...Array(31).keys()].map(i => `<option value="${i+1}" ${this.dataset.yearlyBillDay == i+1 ? 'selected' : ''}>${i+1}</option>`).join('')}
                    </select>
                </div>

                <div class="button-container">
                    <button type="submit">Save Changes</button>
                </div>
            `;
            form.innerHTML = formContent;

            // Add event listener for the new select dropdown
            form.querySelector('#modal_line_item_type').addEventListener('change', function() {
                document.getElementById('modal_recurring_fields').style.display = this.value === 'recurring' ? 'block' : 'none';
                document.getElementById('modal_one_off_fields').style.display = this.value === 'one_off' ? 'block' : 'none';
                document.getElementById('modal_yearly_fields').style.display = this.value === 'yearly' ? 'block' : 'none';
            });

            lineItemModal.style.display = 'block';
        });
    });
});
</script>
{% endblock %}
