<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Integotec - {{ client.name }}</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f4f6f8; color: #212529; margin: 0; padding: 20px; }
        .container { max-width: 90%; margin: 0 auto; }
        h1, h2, h3 { color: #0056b3; }
        h1 { text-align: center; margin-bottom: 10px; }
        h2 { margin-top: 40px; border-top: 1px solid #ccc; padding-top: 20px;}
        table { width: 100%; border-collapse: collapse; background-color: #ffffff; box-shadow: 0 2px 8px rgba(0,0,0,0.1); font-size: 1em; margin-bottom: 20px; }
        th, td { border: 1px solid #ced4da; padding: 12px 15px; text-align: left; vertical-align: middle; }
        th { background-color: #e9ecef; font-weight: 600; }
        .nav-link { display: block; text-align: center; margin-bottom: 30px; font-size: 1.1em; }
        .grid-container { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
        .info-card { background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .billing-form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; align-items: center; }
        .billing-form-grid label { font-weight: bold; }
        .billing-form-grid input { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .button-container { text-align: right; margin-top: 20px; }
        .override-toggle { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; font-size: 1.1em; }
        .receipt-table { width: 100%; }
        .receipt-table td { border: none; padding: 8px 0; }
        .receipt-table .label { text-align: left; }
        .receipt-table .value { text-align: right; }
        .receipt-table .total-row td { border-top: 2px solid #333; font-weight: bold; padding-top: 10px; }
        .backup-breakdown { padding-left: 20px; font-size: 0.9em; color: #555; }
    </style>
</head>
<body>
    <div class="container">
        <h1>{{ client.name }}</h1>
        <a href="/" class="nav-link">← Back to Dashboard</a>

        <div class="grid-container">
            <div class="info-card">
                <h3>Client Details</h3>
                <p><strong>Account Number:</strong> {{ client.account_number }}</p>
                <p><strong>Assigned Plan:</strong> {{ client.billing_plan }}</p>
                <p><strong>Contract Term:</strong> {{ client.contract_term_length }}</p>
                <p><strong>Contract Start:</strong> {{ client.contract_start_date }}</p>
            </div>
            <div class="info-card">
                <h3>Billing Receipt</h3>
                <table class="receipt-table">
                    <tr><td class="label">Network Management Fee</td><td class="value">${{ "%.2f"|format(receipt_data.nmf) }}</td></tr>
                    <tr><td class="label">User Cost ({{ user_count }} users × ${{ "%.2f"|format(effective_rates.puc) }})</td><td class="value">${{ "%.2f"|format(receipt_data.user_charge) }}</td></tr>
                    <tr><td class="label">Workstation Cost ({{ workstation_count }} devices × ${{ "%.2f"|format(effective_rates.pwc) }})</td><td class="value">${{ "%.2f"|format(receipt_data.workstation_charge) }}</td></tr>
                    <tr><td class="label">Host Cost ({{ host_count }} hosts × ${{ "%.2f"|format(effective_rates.phc) }})</td><td class="value">${{ "%.2f"|format(receipt_data.host_charge) }}</td></tr>
                    <tr><td class="label">VM Cost ({{ vm_count }} VMs × ${{ "%.2f"|format(effective_rates.pvc) }})</td><td class="value">${{ "%.2f"|format(receipt_data.vm_charge) }}</td></tr>
                    <tr><td class="label"><strong>Backup Charge</strong></td><td class="value"><strong>${{ "%.2f"|format(receipt_data.backup_charge) }}</strong></td></tr>
                    <tr class="backup-breakdown"><td class="label">Workstation Backup Base Fee ({{ backed_up_workstations }} devices × ${{ "%.2f"|format(effective_rates.bbfw) }})</td><td class="value">${{ "%.2f"|format(receipt_data.backup_base_workstation) }}</td></tr>
                    <tr class="backup-breakdown"><td class="label">Server Backup Base Fee ({{ backed_up_servers }} devices × ${{ "%.2f"|format(effective_rates.bbfs) }})</td><td class="value">${{ "%.2f"|format(receipt_data.backup_base_server) }}</td></tr>
                    <tr class="backup-breakdown"><td class="label">Total Included Storage</td><td class="value">{{ "%.2f"|format(receipt_data.total_included_tb) }} TB</td></tr>
                    <tr class="backup-breakdown"><td class="label">Total Used Storage</td><td class="value">{{ "%.2f"|format(total_backup_tb) }} TB</td></tr>
                    <tr class="backup-breakdown"><td class="label">Storage Overage ({{ "%.2f"|format(receipt_data.overage_tb) }} TB × ${{ "%.2f"|format(effective_rates.bpt) }})</td><td class="value">${{ "%.2f"|format(receipt_data.overage_charge) }}</td></tr>
                    <tr class="total-row"><td class="label">Estimated Total</td><td class="value">${{ "%.2f"|format(receipt_data.total) }}</td></tr>
                </table>
            </div>
        </div>

        <div class="info-card" style="margin-top: 20px;">
            <h3>Billing Override Settings</h3>
            <form method="POST" action="{{ url_for('client_settings', account_number=client.account_number) }}">
                <div class="override-toggle">
                    <input type="checkbox" id="override_enabled" name="override_enabled" {% if plan_details.override_enabled %}checked{% endif %}>
                    <label for="override_enabled"><strong>Enable Override</strong> (Use these values instead of the default)</label>
                </div>
                <div class="billing-form-grid">
                    <div>
                        <label>Network Management Fee</label>
                        <input type="number" step="0.01" name="network_management_fee" value="{{ '%.2f'|format(plan_details.override_nmf if plan_details.override_nmf is not none else plan_details.default_nmf) }}">
                    </div>
                    <div>
                        <label>Per User Cost</label>
                        <input type="number" step="0.01" name="per_user_cost" value="{{ '%.2f'|format(plan_details.override_puc if plan_details.override_puc is not none else plan_details.default_puc) }}">
                    </div>
                    <div>
                        <label>Per Workstation Cost</label>
                        <input type="number" step="0.01" name="per_workstation_cost" value="{{ '%.2f'|format(plan_details.override_pwc if plan_details.override_pwc is not none else plan_details.default_pwc) }}">
                    </div>
                    <div>
                        <label>Per Host Cost</label>
                        <input type="number" step="0.01" name="per_host_cost" value="{{ '%.2f'|format(plan_details.override_phc if plan_details.override_phc is not none else plan_details.default_phc) }}">
                    </div>
                    <div>
                        <label>Per VM Cost</label>
                        <input type="number" step="0.01" name="per_vm_cost" value="{{ '%.2f'|format(plan_details.override_pvc if plan_details.override_pvc is not none else plan_details.default_pvc) }}">
                    </div>
                    <div>
                        <label>Backup Base Fee (Workstation)</label>
                        <input type="number" step="0.01" name="backup_base_fee_workstation" value="{{ '%.2f'|format(plan_details.override_bbfw if plan_details.override_bbfw is not none else plan_details.default_bbfw) }}">
                    </div>
                    <div>
                        <label>Backup Base Fee (Server)</label>
                        <input type="number" step="0.01" name="backup_base_fee_server" value="{{ '%.2f'|format(plan_details.override_bbfs if plan_details.override_bbfs is not none else plan_details.default_bbfs) }}">
                    </div>
                    <div>
                        <label>Backup Included (TB)</label>
                        <input type="number" step="0.01" name="backup_included_tb" value="{{ '%.2f'|format(plan_details.override_bit if plan_details.override_bit is not none else plan_details.default_bit) }}">
                    </div>
                    <div>
                        <label>Backup Per TB Fee</label>
                        <input type="number" step="0.01" name="backup_per_tb_fee" value="{{ '%.2f'|format(plan_details.override_bpt if plan_details.override_bpt is not none else plan_details.default_bpt) }}">
                    </div>
                </div>
                <div class="button-container"><button type="submit">Save Override Settings</button></div>
            </form>
        </div>

        <h2>Recent Ticket Activity (Last 30 Days)</h2>
        <table>
            <thead>
                <tr>
                    <th>Ticket ID</th>
                    <th>Subject</th>
                    <th>Date Closed</th>
                    <th>Total Hours</th>
                </tr>
            </thead>
            <tbody>
                {% for ticket in recent_tickets %}
                <tr>
                    <td><a href="https://integotecllc.freshservice.com/a/tickets/{{ ticket.ticket_id }}" target="_blank">#{{ ticket.ticket_id }}</a></td>
                    <td>{{ ticket.subject }}</td>
                    <td>{{ ticket.closed_at | humanize if ticket.closed_at else 'Still Open' }}</td>
                    <td>{{ "%.2f"|format(ticket.total_hours_spent) }}</td>
                </tr>
                {% else %}
                <tr><td colspan="4">No recent tickets with time entries found.</td></tr>
                {% endfor %}
            </tbody>
        </table>

        <h2>Tracked Assets & Users</h2>
        <div class="grid-container">
            <div>
                <h4>Datto RMM Assets ({{ assets|length }})</h4>
                <table><thead><tr><th>Hostname</th><th>Type</th><th>Server Type</th><th>OS</th><th>Backup Usage (TB)</th></tr></thead><tbody>
                    {% for asset in assets %}<tr><td>{{ asset.hostname }}</td><td>{{ asset.device_type }}</td><td>{{ asset.server_type or 'N/A' }}</td><td>{{ asset.operating_system }}</td><td>{{ "%.4f"|format(asset.backup_data_tb) }}</td></tr>{% else %}<tr><td colspan="5">No assets found.</td></tr>{% endfor %}
                </tbody></table>
            </div>
            <div>
                <h4>Freshservice Users ({{ users|length }})</h4>
                <table><thead><tr><th>Full Name</th><th>Email</th><th>Status</th></tr></thead><tbody>
                    {% for user in users %}<tr><td>{{ user.full_name }}</td><td>{{ user.email }}</td><td>{{ user.status }}</td></tr>{% else %}<tr><td colspan="3">No users found.</td></tr>{% endfor %}
                </tbody></table>
            </div>
        </div>

    </div>
</body>
</html>
