{# hamnertime/integodash/integodash-b7a03f16877fb4e6590039b6f2c0b632176ef6cd/templates/clients.html #}
{% extends "layout.html" %}
{% block title %}Clients{% endblock %}

{% block content %}
<h1>All Clients</h1>

<div class="billing-controls">
    <div class="export-section">
        <button class="button" id="add-client-btn">Add New Client</button>
    </div>
    <div class="search-clients">
        <input type="text" id="client-search" placeholder="Search clients...">
    </div>
</div>

<div class="billing-controls">
    <div class="export-section">
        <form action="{{ url_for('export_all_bills_zip') }}" method="POST">
            <strong>Export All Invoices for:</strong>
            <select name="month">
                {% for month in month_options %}
                    <option value="{{ month.value }}">{{ month.name }}</option>
                {% endfor %}
            </select>
            <input type="number" name="year" value="{{ current_year }}" style="width: 80px;">
            <button type="submit" class="button">Download ZIP</button>
        </form>
    </div>
</div>

<table class="client-table">
    <thead>
        <tr>
            <th><a href="#" class="sort-link" data-sort="name">Company Name<span class="sort-arrow"></span></a></th>
            <th><a href="#" class="sort-link" data-sort="billing_plan">Billing Plan<span class="sort-arrow"></span></a></th>
            <th><a href="#" class="sort-link" data-sort="workstations">Workstations<span class="sort-arrow"></span></a></th>
            <th><a href="#" class="sort-link" data-sort="servers">Servers<span class="sort-arrow"></span></a></th>
            <th><a href="#" class="sort-link" data-sort="vms">VMs<span class="sort-arrow"></span></a></th>
            <th><a href="#" class="sort-link" data-sort="regular_users">Regular Users<span class="sort-arrow"></span></a></th>
            <th><a href="#" class="sort-link" data-sort="backup">Backup (TB)<span class="sort-arrow"></span></a></th>
            <th><a href="#" class="sort-link" data-sort="hours">Hours (This Year)<span class="sort-arrow"></span></a></th>
            <th><a href="#" class="sort-link" data-sort="bill">Calculated Bill<span class="sort-arrow"></span></a></th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody id="client-table-body">
        {% if clients %}
            {% for client in clients %}
            <tr>
                <td data-sort-value="{{ client.name }}"><strong><a href="{{ url_for('client_billing_details', account_number=client.account_number) }}">{{ client.name }}</a></strong></td>
                <td data-sort-value="{{ client.billing_plan }}">{{ client['billing_plan'] }}</td>
                <td data-sort-value="{{ client.workstations }}">{{ client['workstations'] }}</td>
                <td data-sort-value="{{ client.servers }}">{{ client['servers'] }}</td>
                <td data-sort-value="{{ client.vms }}">{{ client['vms'] }}</td>
                <td data-sort-value="{{ client.regular_users }}">{{ client['regular_users'] }}</td>
                <td data-sort-value="{{ client.total_backup_bytes }}">{{ "%.2f"|format(client['total_backup_bytes'] / 1099511627776.0) }}</td>
                <td data-sort-value="{{ client.total_hours }}">{{ "%.2f"|format(client['total_hours']) }}</td>
                <td data-sort-value="{{ client.total_bill }}">${{ "%.2f"|format(client['total_bill']) }}</td>
                <td>
                    <form action="{{ url_for('delete_client', account_number=client.account_number) }}" method="POST" onsubmit="return confirm('Are you sure you want to delete this client?');">
                        <button type="submit" class="icon-button delete">
                            <svg viewBox="0 0 24 24"><path d="M9,3V4H4V6H5V19C5,20.1 5.9,21 7,21H17C18.1,21 19,20.1 19,19V6H20V4H15V3H9M7,6H17V19H7V6M9,8V17H11V8H9M13,8V17H15V8H13Z" /></svg>
                        </button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        {% else %}
            <tr>
                <td colspan="10" style="text-align: center;">No clients found in the database. Run sync scripts from the settings page.</td>
            </tr>
        {% endif %}
    </tbody>
</table>

<div id="addClientModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Add New Client</h2>
            <span class="close-button">&times;</span>
        </div>
        <form id="addClientForm" method="POST" action="{{ url_for('add_client') }}">
            <div class="form-grid" style="grid-template-columns: auto 1fr;">
                <label for="account_number">Account Number</label>
                <input type="text" id="account_number" name="account_number" required>

                <label for="name">Company Name</label>
                <input type="text" name="name" id="name" required>

                <label for="billing_plan">Billing Plan</label>
                <select name="billing_plan" id="billing_plan" required>
                    <option value="">-- Select a Plan --</option>
                    {% for plan in billing_plans %}
                        <option value="{{ plan.billing_plan }}">{{ plan.billing_plan }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="button-container" style="text-align: right; margin-top: 20px;">
                 <button type="submit" class="button">Add Client</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const addClientBtn = document.getElementById('add-client-btn');
    const addClientModal = document.getElementById('addClientModal');
    const closeButton = addClientModal.querySelector('.close-button');

    addClientBtn.addEventListener('click', () => {
        addClientModal.style.display = 'block';
    });

    closeButton.addEventListener('click', () => {
        addClientModal.style.display = 'none';
    });

    window.addEventListener('click', (event) => {
        if (event.target == addClientModal) {
            addClientModal.style.display = 'none';
        }
    });

    const clientSearch = document.getElementById('client-search');
    if(clientSearch) {
        clientSearch.addEventListener('input', function() {
            const searchQuery = this.value.toLowerCase();
            const tableBody = document.getElementById('client-table-body');
            const rows = tableBody.getElementsByTagName('tr');
            for (let i = 0; i < rows.length; i++) {
                const cells = rows[i].getElementsByTagName('td');
                let rowVisible = false;
                if (cells.length > 0) {
                    const clientName = cells[0].textContent.toLowerCase();
                    const billingPlan = cells[1].textContent.toLowerCase();
                    if (clientName.includes(searchQuery) || billingPlan.includes(searchQuery)) {
                        rowVisible = true;
                    }
                }
                rows[i].style.display = rowVisible ? '' : 'none';
            }
        });
    }

    let currentSort = { column: 'name', order: 'asc' };

    document.querySelectorAll('.sort-link').forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const column = this.dataset.sort;
            let order = 'asc';
            if (currentSort.column === column && currentSort.order === 'asc') {
                order = 'desc';
            }
            currentSort = { column, order };
            sortTable(column, order);
            updateSortArrows();
        });
    });

    function sortTable(column, order) {
        const tableBody = document.getElementById('client-table-body');
        const rows = Array.from(tableBody.getElementsByTagName('tr'));

        rows.sort((a, b) => {
            const aVal = a.cells[getColumnIndex(column)].dataset.sortValue;
            const bVal = b.cells[getColumnIndex(column)].dataset.sortValue;

            const isNumeric = !isNaN(parseFloat(aVal)) && isFinite(aVal);

            let comparison = 0;
            if (isNumeric) {
                comparison = parseFloat(aVal) - parseFloat(bVal);
            } else {
                comparison = aVal.localeCompare(bVal);
            }

            return order === 'asc' ? comparison : -comparison;
        });

        rows.forEach(row => tableBody.appendChild(row));
    }

    function getColumnIndex(columnName) {
        const headers = document.querySelectorAll('.client-table th');
        for (let i = 0; i < headers.length; i++) {
            const link = headers[i].querySelector('.sort-link');
            if (link && link.dataset.sort === columnName) {
                return i;
            }
        }
        return 0;
    }

    function updateSortArrows() {
        document.querySelectorAll('.sort-arrow').forEach(arrow => {
            arrow.textContent = '';
        });
        const activeLink = document.querySelector(`.sort-link[data-sort="${currentSort.column}"]`);
        if (activeLink) {
            const arrow = activeLink.querySelector('.sort-arrow');
            arrow.textContent = currentSort.order === 'asc' ? '▲' : '▼';
        }
    }
    sortTable(currentSort.column, currentSort.order);
    updateSortArrows();
});
</script>
{% endblock %}
