{% extends "layout.html" %}
{% block title %}Clients{% endblock %}

{% block head %}
<style>
.grid-stack-item-content {
    background-color: var(--card-bg);
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    padding: 20px;
    color: var(--text-color);
    overflow: auto;
}
</style>
{% endblock %}

{% block content %}
<h1>All Clients</h1>

<div class="grid-stack">
    <div class="grid-stack-item" gs-id="export-all-widget" gs-w="4" gs-h="2">
        <div class="grid-stack-item-content">
            <h2>Export All Invoices</h2>
            <form action="{{ url_for('export_all_bills_zip') }}" method="POST">
                <strong>Export for:</strong>
                <select name="month">
                    {% for month in month_options %}
                        <option value="{{ month.value }}">{{ month.name }}</option>
                    {% endfor %}
                </select>
                <input type="number" name="year" value="{{ current_year }}" style="width: 80px;">
                <button type="submit" class="button">Download ZIP</button>
            </form>
        </div>
    </div>
    <div class="grid-stack-item" gs-id="clients-table-widget" gs-x="0" gs-y="2" gs-w="12" gs-h="6">
        <div class="grid-stack-item-content">
            <div id="clients-table-container">
                {# This container will be filled dynamically by JavaScript #}
            </div>
        </div>
    </div>
</div>

<div id="addClientModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Add New Client</h2>
            <span class="close-button">&times;</span>
        </div>
        <form id="addClientForm" method="POST" action="{{ url_for('add_client') }}">
            <div class="form-grid" style="grid-template-columns: auto 1fr;">
                <label for="account_number">Account Number</label>
                <input type="text" id="account_number" name="account_number" required>

                <label for="name">Company Name</label>
                <input type="text" name="name" id="name" required>

                <label for="billing_plan">Billing Plan</label>
                <select name="billing_plan" id="billing_plan" required>
                    <option value="">-- Select a Plan --</option>
                    {% for plan in billing_plans %}
                        <option value="{{ plan.billing_plan }}">{{ plan.billing_plan }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="button-container" style="text-align: right; margin-top: 20px;">
                 <button type="submit" class="button">Add Client</button>
            </div>
        </form>
    </div>
</div>

<div id="columnChooserModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Choose Columns to Display</h2>
            <span class="close-button">&times;</span>
        </div>
        <form id="columnChooserForm">
            <div class="column-chooser-grid">
                {% for key, value in columns.items() %}
                    <label>
                        <input type="checkbox" name="{{ key }}" {% if visible_columns[key] %}checked{% endif %}>
                        {{ value.label }}
                    </label>
                {% endfor %}
            </div>
            <div class="button-container">
                <button type="submit" class="button">Save Preferences</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const addClientModal = document.getElementById('addClientModal');
    const columnChooserModal = document.getElementById('columnChooserModal');
    let grid = GridStack.init();
    const savedLayout = {{ layout|tojson|safe }};

    if (savedLayout) {
        // We pass false to load() to avoid loading the saved content, preventing duplicates
        grid.load(savedLayout, false);
    }

    grid.on('change', function (event, items) {
        // We pass false to save() so it doesn't save the dynamic content
        const layout = grid.save(false);
        fetch('/save_layout/clients', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({layout: layout}),
        });
    });


    function closeModal(modal) {
        if (modal) {
            modal.style.display = 'none';
        }
    }

    document.querySelectorAll('.close-button').forEach(button => {
        button.addEventListener('click', (e) => {
            closeModal(e.target.closest('.modal'));
        });
    });

    window.addEventListener('click', (event) => {
        if (event.target.classList.contains('modal')) {
            closeModal(event.target);
        }
    });

    const clientsContainer = document.getElementById('clients-table-container');
    let searchTimeout;

    let clientsState = {
        page: 1,
        per_page: 50,
        search_query: '',
        sort_by: 'name',
        sort_order: 'asc'
    };

    const fetchClients = async () => {
        const url = new URL(`${window.location.origin}/clients/partial`);
        url.searchParams.set('page', clientsState.page);
        url.searchParams.set('per_page', clientsState.per_page);
        url.searchParams.set('search', clientsState.search_query);
        url.searchParams.set('sort_by', clientsState.sort_by);
        url.searchParams.set('sort_order', clientsState.sort_order);

        try {
            const response = await fetch(url);
            if (!response.ok) throw new Error('Network response was not ok');
            const html = await response.text();

            const clientSearch = document.getElementById('client-search');
            const searchInputIsFocused = (document.activeElement === clientSearch);
            const cursorPosition = clientSearch ? clientSearch.selectionStart : 0;

            clientsContainer.innerHTML = html;

            if (searchInputIsFocused) {
                const newClientSearch = document.getElementById('client-search');
                newClientSearch.focus();
                newClientSearch.setSelectionRange(cursorPosition, cursorPosition);
            }
        } catch (error) {
            console.error('Failed to fetch clients:', error);
            clientsContainer.innerHTML = '<p class="flash-error">Error loading clients. Please try refreshing the page.</p>';
        }
    };

    clientsContainer.addEventListener('input', function(e) {
        if (e.target.id === 'client-search') {
            clientsState.search_query = e.target.value;
            clientsState.page = 1;
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                fetchClients();
            }, 300);
        }
    });

    document.getElementById('columnChooserForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        try {
            const response = await fetch('/save_column_prefs/clients', {
                method: 'POST',
                body: formData
            });
            if (response.ok) {
                closeModal(columnChooserModal);
                location.reload(); // Reload to apply new column settings
            } else {
                alert('Failed to save preferences.');
            }
        } catch (error) {
            console.error('Error saving column preferences:', error);
        }
    });

    document.addEventListener('click', function(event) {
        if (event.target.closest('#add-client-btn')) {
            addClientModal.style.display = 'block';
        }
        if (event.target.closest('#column-chooser-btn')) {
            columnChooserModal.style.display = 'block';
        }
        if (event.target.closest('#refresh-btn')) {
            fetchClients();
        }
    });

    clientsContainer.addEventListener('click', function(event) {
        const sortLink = event.target.closest('.sort-link');
        const paginationLink = event.target.closest('.pagination-link');

        if (sortLink) {
            event.preventDefault();
            const column = sortLink.dataset.sort;
            if (clientsState.sort_by === column) {
                clientsState.sort_order = clientsState.sort_order === 'asc' ? 'desc' : 'asc';
            } else {
                clientsState.sort_by = column;
                clientsState.sort_order = 'asc';
            }
            fetchClients();
        } else if (paginationLink) {
            event.preventDefault();
            clientsState.page = paginationLink.dataset.page;
            fetchClients();
        }
    });

    clientsContainer.addEventListener('change', function(event) {
        if (event.target.id === 'per_page') {
            clientsState.per_page = event.target.value;
            clientsState.page = 1;
            fetchClients();
        }
    });

    fetchClients();
});
</script>
{% endblock %}
