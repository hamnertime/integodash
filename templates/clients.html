{% extends "layout.html" %}
{% block title %}Clients{% endblock %}

{% block head %}
{% endblock %}

{% block content %}
<h1>All Clients</h1>
<div class="grid-stack">
    <div class="grid-stack-item" gs-id="export-all-widget" gs-w="4" gs-h="2">
        <div class="grid-stack-item-content">
            <h2>Export All Invoices</h2>
            <form action="{{ url_for('export_all_bills_zip') }}" method="POST">
                <strong>Export for:</strong>
                <select name="month">
                    {% for month in month_options %}
                        <option value="{{ month.value }}">{{ month.name }}</option>
                    {% endfor %}
                </select>
                <input type="number" name="year" value="{{ current_year }}" style="width: 80px;">
                <button type="submit" class="button">Download ZIP</button>
            </form>
        </div>
    </div>

    <div class="grid-stack-item" gs-id="clients-table-widget" gs-x="0" gs-y="2" gs-w="12" gs-h="8">
        <div class="grid-stack-item-content">
            <div class="billing-controls">
                <div class="export-section">
                    <button class="button" id="add-client-btn">Add New Client</button>
                </div>
                <div class="search-clients">
                        <input type="text" id="client-search" placeholder="Search clients...">
                </div>
            </div>

                    <div class="table-actions">
                        <button id="refresh-btn" class="icon-button" title="Refresh Table">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="currentColor" d="M17.65,6.35C16.2,4.9 14.21,4 12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20C15.73,20 18.84,17.45 19.73,14H17.65C16.83,16.33 14.61,18 12,18A6,6 0 0,1 6,12A6,6 0 0,1 12,6C13.66,6 15.14,6.69 16.22,7.78L13,11H20V4L17.65,6.35Z" /></svg>
                        </button>
                        <button id="column-chooser-btn" class="icon-button" title="Choose Columns">
                            <svg viewBox="0 0 24 24"><path fill="currentColor" d="M12,15.5A3.5,3.5 0 0,1 8.5,12A3.5,3.5 0 0,1 12,8.5A3.5,3.5 0 0,1 15.5,12A3.5,3.5 0 0,1 12,15.5M19.43,12.97C19.47,12.65 19.5,12.33 19.5,12C19.5,11.67 19.47,11.34 19.43,11L21.54,9.37C21.73,9.22 21.78,8.95 21.66,8.73L19.66,5.27C19.54,5.05 19.27,4.96 19.05,5.05L16.56,6.05C16.04,5.66 15.5,5.32 14.87,5.07L14.5,2.42C14.46,2.18 14.25,2 14,2H10C9.75,2 9.54,2.18 9.5,2.42L9.13,5.07C8.5,5.32 7.96,5.66 7.44,6.05L4.95,5.05C4.73,4.96 4.46,5.05 4.34,5.27L2.34,8.73C2.21,8.95 2.27,9.22 2.46,9.37L4.57,11C4.53,11.34 4.5,11.67 4.5,12C4.5,12.33 4.53,12.65 4.57,12.97L2.46,14.63C2.27,14.78 2.21,15.05 2.34,15.27L4.34,18.73C4.46,18.95 4.73,19.03 4.95,18.95L7.44,17.94C7.96,18.34 8.5,18.68 9.13,18.93L9.5,21.58C9.54,21.82 9.75,22 10,22H14C14.25,22 14.46,21.82 14.5,21.58L14.87,18.93C15.5,18.68 16.04,18.34 16.56,17.94L19.05,18.95C19.27,19.03 19.54,18.95 19.66,18.73L21.66,15.27C21.78,15.05 21.73,14.78 21.54,14.63L19.43,12.97Z" /></svg>
                        </button>
                    </div>



            <div id="clients-table-container">
                {# This container will be filled dynamically by JavaScript #}
            </div>
        </div>
    </div>
</div>

<div id="addClientModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Add New Client</h2>
            <span class="close-button">&times;</span>
        </div>
        <form id="addClientForm" method="POST" action="{{ url_for('add_client') }}">
            <div class="form-grid" style="grid-template-columns: auto 1fr;">
                <label for="account_number">Account Number</label>
                <input type="text" id="account_number" name="account_number" required>

                <label for="name">Company Name</label>
                <input type="text" name="name" id="name" required>

                <label for="billing_plan">Billing Plan</label>
                <select name="billing_plan" id="billing_plan" required>
                    <option value="">-- Select a Plan --</option>
                    {% for plan in billing_plans %}
                        <option value="{{ plan.billing_plan }}">{{ plan.billing_plan }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="button-container" style="text-align: right; margin-top: 20px;">
                 <button type="submit" class="button">Add Client</button>
            </div>
        </form>
    </div>
</div>

<div id="columnChooserModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Choose Columns to Display</h2>
            <span class="close-button">&times;</span>
        </div>
        <form id="columnChooserForm">
            <div class="column-chooser-grid">
                {% for key, value in columns.items() %}
                    <label>
                        <input type="checkbox" name="{{ key }}" {% if visible_columns[key] %}checked{% endif %}>
                        {{ value.label }}
                    </label>
                {% endfor %}
            </div>
            <div class="button-container">
                <button type="submit" class="button">Save Preferences</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const addClientModal = document.getElementById('addClientModal');
    const columnChooserModal = document.getElementById('columnChooserModal');
    let grid = GridStack.init();
    const savedLayout = {{ layout|tojson|safe }};

    if (savedLayout) {
        // We pass false to load() to avoid loading the saved content, preventing duplicates
        grid.load(savedLayout, false);
    }

    grid.on('change', function (event, items) {
        // We pass false to save() so it doesn't save the dynamic content
        const layout = grid.save(false);
        fetch('/save_layout/clients', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({layout: layout}),
        });
    });


    function closeModal(modal) {
        if (modal) {
            modal.style.display = 'none';
        }
    }

    document.querySelectorAll('.close-button').forEach(button => {
        button.addEventListener('click', (e) => {
            closeModal(e.target.closest('.modal'));
        });
    });

    window.addEventListener('click', (event) => {
        if (event.target.classList.contains('modal')) {
            closeModal(event.target);
        }
    });

    const clientsContainer = document.getElementById('clients-table-container');
    const clientSearch = document.getElementById('client-search');
    let searchTimeout;

    let clientsState = {
        page: 1,
        per_page: 50,
        search_query: '',
        sort_by: 'name',
        sort_order: 'asc'
    };

    const fetchClients = async () => {
        const url = new URL(`${window.location.origin}/clients/partial`);
        url.searchParams.set('page', clientsState.page);
        url.searchParams.set('per_page', clientsState.per_page);
        url.searchParams.set('search', clientsState.search_query);
        url.searchParams.set('sort_by', clientsState.sort_by);
        url.searchParams.set('sort_order', clientsState.sort_order);

        try {
            const response = await fetch(url);
            if (!response.ok) throw new Error('Network response was not ok');
            const html = await response.text();

            const searchInputIsFocused = (document.activeElement === clientSearch);
            const cursorPosition = clientSearch ? clientSearch.selectionStart : 0;

            clientsContainer.innerHTML = html;

            if (searchInputIsFocused) {
                const newClientSearch = document.getElementById('client-search');
                newClientSearch.focus();
                newClientSearch.setSelectionRange(cursorPosition, cursorPosition);
            }
        } catch (error) {
            console.error('Failed to fetch clients:', error);
            clientsContainer.innerHTML = '<p class="flash-error">Error loading clients. Please try refreshing the page.</p>';
        }
    };

    if (clientSearch) {
        clientSearch.addEventListener('input', function(e) {
            clientsState.search_query = e.target.value;
            clientsState.page = 1;
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                fetchClients();
            }, 300);
        });
    }

    document.getElementById('columnChooserForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        try {
            const response = await fetch('/save_column_prefs/clients', {
                method: 'POST',
                body: formData
            });
            if (response.ok) {
                closeModal(columnChooserModal);
                location.reload(); // Reload to apply new column settings
            } else {
                alert('Failed to save preferences.');
            }
        } catch (error) {
            console.error('Error saving column preferences:', error);
        }
    });

    document.addEventListener('click', function(event) {
        if (event.target.closest('#add-client-btn')) {
            addClientModal.style.display = 'block';
        }
        if (event.target.closest('#column-chooser-btn')) {
            columnChooserModal.style.display = 'block';
        }
        if (event.target.closest('#refresh-btn')) {
            fetchClients();
        }
    });

    clientsContainer.addEventListener('click', function(event) {
        const sortLink = event.target.closest('.sort-link');
        const paginationLink = event.target.closest('.pagination-link');

        if (sortLink) {
            event.preventDefault();
            const column = sortLink.dataset.sort;
            if (clientsState.sort_by === column) {
                clientsState.sort_order = clientsState.sort_order === 'asc' ? 'desc' : 'asc';
            } else {
                clientsState.sort_by = column;
                clientsState.sort_order = 'asc';
            }
            fetchClients();
        } else if (paginationLink) {
            event.preventDefault();
            clientsState.page = paginationLink.dataset.page;
            fetchClients();
        }
    });

    clientsContainer.addEventListener('change', function(event) {
        if (event.target.id === 'per_page') {
            clientsState.per_page = event.target.value;
            clientsState.page = 1;
            fetchClients();
        }
    });

    fetchClients();
});
</script>
{% endblock %}
