{# hamnertime/integodash/integodash-b7a03f16877fb4e6590039b6f2c0b632176ef6cd/templates/contacts.html #}
{% extends "layout.html" %}
{% block title %}Contacts{% endblock %}

{% block content %}
<h1>All Contacts</h1>

<div class="billing-controls">
    <div class="export-section">
        <button class="button" id="add-contact-btn">Add New Contact</button>
    </div>
    <div class="search-clients">
        <input type="text" id="contact-search" name="search" placeholder="Search contacts...">
    </div>
</div>

<div id="contacts-table-container">
    {# This container will be filled dynamically by JavaScript #}
</div>

<div id="contactModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="contactModalTitle">Add New Contact</h2>
            <span class="close-button">&times;</span>
        </div>
        <form id="contactForm" method="POST">
            <div class="form-row">
                <div>
                    <label for="first_name">First Name</label>
                    <input type="text" id="first_name" name="first_name" required>
                </div>
                <div>
                    <label for="last_name">Last Name</label>
                    <input type="text" id="last_name" name="last_name" required>
                </div>
            </div>
            <div class="form-row">
                <div>
                    <label for="email">Email</label>
                    <input type="email" id="email" name="email">
                </div>
                <div>
                    <label for="title">Title</label>
                    <input type="text" id="title" name="title">
                </div>
            </div>
            <div class="form-row">
                <div>
                    <label for="company_account_number">Company</label>
                    <select id="company_account_number" name="company_account_number">
                        {% for company in companies %}
                        <option value="{{ company.account_number }}">{{ company.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label for="work_phone">Work Phone</label>
                    <input type="text" id="work_phone" name="work_phone">
                </div>
            </div>
            <div class="form-row">
                <div>
                    <label for="mobile_phone">Mobile Phone</label>
                    <input type="text" id="mobile_phone" name="mobile_phone">
                </div>
                <div>
                    <label for="employment_type">Employment Type</label>
                    <select id="employment_type" name="employment_type">
                        <option value="Full Time">Full Time</option>
                        <option value="Part Time">Part Time</option>
                    </select>
                </div>
            </div>
            <div class="form-row">
                <div>
                    <label for="status">Status</label>
                    <select id="status" name="status">
                        <option value="Active">Active</option>
                        <option value="Inactive">Inactive</option>
                    </select>
                </div>
                <div>
                    <label for="other_emails">Other Emails</label>
                    <input type="text" id="other_emails" name="other_emails">
                </div>
            </div>
            <div>
                <label for="address">Address</label>
                <textarea id="address" name="address" rows="3"></textarea>
            </div>
            <div>
                <label for="notes">Notes</label>
                <textarea id="notes" name="notes" rows="3"></textarea>
            </div>
            <div class="button-container">
                <button type="submit">Save Contact</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const contactsContainer = document.getElementById('contacts-table-container');
    const contactSearch = document.getElementById('contact-search');
    let searchTimeout;

    let contactsState = {
        page: 1,
        per_page: 50,
        search_query: '',
        sort_by: 'name',
        sort_order: 'asc'
    };

    const fetchContacts = async () => {
        const url = new URL(`${window.location.origin}/contacts/partial`);
        url.searchParams.set('page', contactsState.page);
        url.searchParams.set('per_page', contactsState.per_page);
        url.searchParams.set('search', contactsState.search_query);
        url.searchParams.set('sort_by', contactsState.sort_by);
        url.searchParams.set('sort_order', contactsState.sort_order);

        try {
            const response = await fetch(url);
            if (!response.ok) throw new Error('Network response was not ok');
            const html = await response.text();
            contactsContainer.innerHTML = html;
        } catch (error) {
            console.error('Failed to fetch contacts:', error);
            contactsContainer.innerHTML = '<p class="flash-error">Error loading contacts. Please try refreshing the page.</p>';
        }
    };

    if(contactSearch) {
        contactSearch.addEventListener('input', function(e) {
            contactsState.search_query = e.target.value;
            contactsState.page = 1;
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                fetchContacts();
            }, 300);
        });
    }

    // Use event delegation on a static parent (document) for clicks
    document.addEventListener('click', function(event) {
        const modal = document.getElementById('contactModal');
        const form = document.getElementById('contactForm');
        const modalTitle = document.getElementById('contactModalTitle');

        // Modal 'Add' button
        if (event.target.id === 'add-contact-btn') {
            modalTitle.textContent = 'Add New Contact';
            form.action = "{{ url_for('add_contact') }}";
            form.reset();
            modal.style.display = 'block';
        }

        // Modal 'Close' button
        const closeButton = event.target.closest('.close-button');
        if (closeButton && closeButton.closest('#contactModal')) {
            modal.style.display = 'none';
        }

        // Clicks inside the dynamic contacts container
        if (contactsContainer.contains(event.target)) {
            const sortLink = event.target.closest('.sort-link');
            const paginationLink = event.target.closest('.pagination-link');
            const editButton = event.target.closest('.edit-contact');

            if (sortLink) {
                event.preventDefault();
                const column = sortLink.dataset.sort;
                if (contactsState.sort_by === column) {
                    contactsState.sort_order = contactsState.sort_order === 'asc' ? 'desc' : 'asc';
                } else {
                    contactsState.sort_by = column;
                    contactsState.sort_order = 'asc';
                }
                fetchContacts();
            } else if (paginationLink) {
                event.preventDefault();
                contactsState.page = paginationLink.dataset.page;
                fetchContacts();
            } else if (editButton) {
                modalTitle.textContent = 'Edit Contact';
                form.action = `/contacts/edit/${editButton.dataset.contactId}`;
                document.getElementById('first_name').value = editButton.dataset.firstName;
                document.getElementById('last_name').value = editButton.dataset.lastName;
                document.getElementById('email').value = editButton.dataset.email;
                document.getElementById('title').value = editButton.dataset.title;
                document.getElementById('company_account_number').value = editButton.dataset.companyAccountNumber;
                document.getElementById('work_phone').value = editButton.dataset.workPhone;
                document.getElementById('mobile_phone').value = editButton.dataset.mobilePhone;
                document.getElementById('employment_type').value = editButton.dataset.employmentType;
                document.getElementById('status').value = editButton.dataset.status;
                document.getElementById('other_emails').value = editButton.dataset.otherEmails;
                document.getElementById('address').value = editButton.dataset.address;
                document.getElementById('notes').value = editButton.dataset.notes;
                modal.style.display = 'block';
            }
        }
    });

    // Use event delegation for the 'change' event on the per_page dropdown
    document.addEventListener('change', function(event) {
        if (event.target.id === 'per_page' && contactsContainer.contains(event.target.form)) {
            contactsState.per_page = event.target.value;
            contactsState.page = 1;
            fetchContacts();
        }
    });

    // Close modal if clicking outside of it
    window.onclick = function(event) {
        const modal = document.getElementById('contactModal');
        if (event.target == modal) {
            modal.style.display = 'none';
        }
    }

    // Initial load
    fetchContacts();
});
</script>
{% endblock %}
