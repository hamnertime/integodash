{% extends "layout.html" %}
{% block title %}Contacts{% endblock %}

{% block head %}
<style>
    #associated-assets-list {
        max-height: 200px;
        overflow-y: auto;
        border: 1px solid var(--input-border);
        padding: 10px;
        border-radius: 4px;
        background-color: var(--background-color);
    }
    #associated-assets-list label {
        display: block;
        margin-bottom: 5px;
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1>All Contacts</h1>
    <button id="restore-layout-btn" class="button">Restore Default Layout</button>
</div>
<div class="grid-stack">
    <div class="grid-stack-item" gs-id="contacts-table-widget" gs-w="12" gs-h="8">
        <div class="grid-stack-item-content">
            <div class="grid-stack-item-header">
                <div class="widget-header-controls">
                    <div class="billing-controls">
                        <div class="export-section">
                            <button class="button" id="add-contact-btn">Add New Contact</button>
                        </div>
                        <div class="search-clients">
                            <input type="text" id="contact-search" name="search" placeholder="Search contacts...">
                        </div>
                    </div>
                    <div class="table-actions">
                        <button id="refresh-btn" class="icon-button" title="Refresh Table">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="currentColor" d="M17.65,6.35C16.2,4.9 14.21,4 12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20C15.73,20 18.84,17.45 19.73,14H17.65C16.83,16.33 14.61,18 12,18A6,6 0 0,1 6,12A6,6 0 0,1 12,6C13.66,6 15.14,6.69 16.22,7.78L13,11H20V4L17.65,6.35Z" /></svg>
                        </button>
                        <button id="column-chooser-btn" class="icon-button" title="Choose Columns">
                            <svg viewBox="0 0 24 24"><path fill="currentColor" d="M12,15.5A3.5,3.5 0 0,1 8.5,12A3.5,3.5 0 0,1 12,8.5A3.5,3.5 0 0,1 15.5,12A3.5,3.5 0 0,1 12,15.5M19.43,12.97C19.47,12.65 19.5,12.33 19.5,12C19.5,11.67 19.47,11.34 19.43,11L21.54,9.37C21.73,9.22 21.78,8.95 21.66,8.73L19.66,5.27C19.54,5.05 19.27,4.96 19.05,5.05L16.56,6.05C16.04,5.66 15.5,5.32 14.87,5.07L14.5,2.42C14.46,2.18 14.25,2 14,2H10C9.75,2 9.54,2.18 9.5,2.42L9.13,5.07C8.5,5.32 7.96,5.66 7.44,6.05L4.95,5.05C4.73,4.96 4.46,5.05 4.34,5.27L2.34,8.73C2.21,8.95 2.27,9.22 2.46,9.37L4.57,11C4.53,11.34 4.5,11.67 4.5,12C4.5,12.33 4.53,12.65 4.57,12.97L2.46,14.63C2.27,14.78 2.21,15.05 2.34,15.27L4.34,18.73C4.46,18.95 4.73,19.03 4.95,18.95L7.44,17.94C7.96,18.34 8.5,18.68 9.13,18.93L9.5,21.58C9.54,21.82 9.75,22 10,22H14C14.25,22 14.46,21.82 14.5,21.58L14.87,18.93C15.5,18.68 16.04,18.34 16.56,17.94L19.05,18.95C19.27,19.03 19.54,18.95 19.66,18.73L21.66,15.27C21.78,15.05 21.73,14.78 21.54,14.63L19.43,12.97Z" /></svg>
                        </button>
                    </div>
                </div>
            </div>
            <div id="contacts-table-container">
                {# This container will be filled dynamically by JavaScript #}
            </div>
        </div>
    </div>
</div>


<div id="contactModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="contactModalTitle">Add New Contact</h2>
            <span class="close-button">&times;</span>
        </div>
        <form id="contactForm" method="POST">
            <div class="form-row">
                <div>
                    <label for="first_name">First Name</label>
                    <input type="text" id="first_name" name="first_name" required>
                </div>
                <div>
                    <label for="last_name">Last Name</label>
                    <input type="text" id="last_name" name="last_name" required>
                </div>
            </div>
            <div class="form-row">
                <div>
                    <label for="email">Email</label>
                    <input type="email" id="email" name="email">
                </div>
                <div>
                    <label for="title">Title</label>
                    <input type="text" id="title" name="title">
                </div>
            </div>
            <div class="form-row">
                <div>
                    <label for="company_account_number">Company</label>
                    <select id="company_account_number" name="company_account_number">
                        {% for company in companies %}
                        <option value="{{ company.account_number }}">{{ company.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label for="work_phone">Work Phone</label>
                    <input type="text" id="work_phone" name="work_phone">
                </div>
            </div>
            <div class="form-row">
                <div>
                    <label for="mobile_phone">Mobile Phone</label>
                    <input type="text" id="mobile_phone" name="mobile_phone">
                </div>
                <div>
                    <label for="employment_type">Employment Type</label>
                    <select id="employment_type" name="employment_type">
                        <option value="Full Time">Full Time</option>
                        <option value="Part Time">Part Time</option>
                    </select>
                </div>
            </div>
            <div class="form-row">
                <div>
                    <label for="status">Status</label>
                    <select id="status" name="status">
                        <option value="Active">Active</option>
                        <option value="Inactive">Inactive</option>
                    </select>
                </div>
                <div>
                    <label for="other_emails">Other Emails</label>
                    <input type="text" id="other_emails" name="other_emails">
                </div>
            </div>
             <div>
                <label for="associated-assets-list">Associated Assets</label>
                <div id="associated-assets-list">Loading assets...</div>
            </div>
            <div>
                <label for="address">Address</label>
                <textarea id="address" name="address" rows="3"></textarea>
            </div>
            <div>
                <label for="notes">Notes</label>
                <textarea id="notes" name="notes" rows="3"></textarea>
            </div>
            <div class="button-container">
                <button type="submit">Save Contact</button>
            </div>
        </form>
    </div>
</div>

<div id="columnChooserModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Choose Columns to Display</h2>
            <span class="close-button">&times;</span>
        </div>
        <form id="columnChooserForm">
            <div class="column-chooser-grid">
                {% for key, value in columns.items() %}
                    <label>
                        <input type="checkbox" name="{{ key }}" {% if visible_columns[key] %}checked{% endif %}>
                        {{ value.label }}
                    </label>
                {% endfor %}
            </div>
            <div class="button-container">
                <button type="submit" class="button">Save Preferences</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function () {
    initializeGrid(
        'contacts',
        {{ layout|tojson|safe }},
        {{ default_layout|tojson|safe }}
    );

    const contactsContainer = document.getElementById('contacts-table-container');
    const contactSearch = document.getElementById('contact-search');
    const columnChooserModal = document.getElementById('columnChooserModal');
    const contactModal = document.getElementById('contactModal');
    let searchTimeout;

    let contactsState = {
        page: 1,
        per_page: 50,
        search_query: '',
        sort_by: 'name',
        sort_order: 'asc'
    };

    function closeModal(modal) {
        if (modal) modal.style.display = 'none';
    }

    document.querySelectorAll('.close-button').forEach(button => {
        button.addEventListener('click', (e) => closeModal(e.target.closest('.modal')));
    });

    window.addEventListener('click', (event) => {
        if (event.target.classList.contains('modal')) closeModal(event.target);
    });

    const fetchContacts = async () => {
        let url = "{{ url_for('contacts.get_contacts_partial') }}";
        const params = new URLSearchParams({
            page: contactsState.page,
            per_page: contactsState.per_page,
            search: contactsState.search_query,
            sort_by: contactsState.sort_by,
            sort_order: contactsState.sort_order
        });
        url = `${url}?${params.toString()}`;

        try {
            const response = await fetch(url);
            if (!response.ok) throw new Error(`Network response was not ok: ${response.statusText}`);
            const html = await response.text();
            contactsContainer.innerHTML = html;
            const newTable = contactsContainer.querySelector('.resizable-table');
            if (newTable) {
                makeTableResizable(newTable);
            }
        } catch (error) {
            console.error('Failed to fetch contacts:', error);
            contactsContainer.innerHTML = `<p class="flash-error">Error loading contacts: ${error.message}. Please try refreshing the page.</p>`;
        }
    };

    const populateAssetList = async (companyAccountNumber, contactId) => {
        const assetListDiv = document.getElementById('associated-assets-list');
        assetListDiv.innerHTML = 'Loading assets...';

        try {
            const [assetsRes, linkedAssetsRes] = await Promise.all([
                fetch(`{{ url_for('contacts.get_assets_for_company', account_number=0) }}`.replace('0', companyAccountNumber)),
                contactId ? fetch(`{{ url_for('contacts.get_linked_assets', contact_id=0) }}`.replace('0', contactId)) : Promise.resolve(null)
            ]);

            const allAssets = await assetsRes.json();
            const linkedAssetIds = contactId ? await linkedAssetsRes.json() : [];

            if (allAssets.length === 0) {
                assetListDiv.innerHTML = 'No assets found for this company.';
                return;
            }

            let assetHtml = '';
            allAssets.forEach(asset => {
                const isChecked = linkedAssetIds.includes(asset.id);
                assetHtml += `
                    <label>
                        <input type="checkbox" name="linked_assets" value="${asset.id}" ${isChecked ? 'checked' : ''}>
                        ${asset.hostname}
                    </label>
                `;
            });
            assetListDiv.innerHTML = assetHtml;
        } catch (error) {
            console.error('Failed to populate asset list:', error);
            assetListDiv.innerHTML = 'Error loading assets.';
        }
    };

    document.getElementById('company_account_number').addEventListener('change', function() {
        populateAssetList(this.value, null); // No contactId for new contacts
    });

    if(contactSearch) {
        contactSearch.addEventListener('input', function(e) {
            contactsState.search_query = e.target.value;
            contactsState.page = 1;
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => fetchContacts(), 300);
        });
    }

    document.getElementById('columnChooserForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        try {
            const response = await fetch("{{ url_for('settings.save_column_prefs', page_name='contacts') }}", {
                method: 'POST',
                body: formData
            });
            if (response.ok) {
                closeModal(columnChooserModal);
                location.reload();
            } else {
                alert('Failed to save preferences.');
            }
        } catch (error) {
            console.error('Error saving column preferences:', error);
        }
    });

    document.addEventListener('click', function(event) {
        const form = document.getElementById('contactForm');
        const modalTitle = document.getElementById('contactModalTitle');

        if (event.target.closest('#add-contact-btn')) {
            modalTitle.textContent = 'Add New Contact';
            form.action = "{{ url_for('contacts.add_contact') }}";
            form.reset();
            const companySelect = document.getElementById('company_account_number');
            populateAssetList(companySelect.value, null);
            contactModal.style.display = 'block';
        }

        if (event.target.closest('#column-chooser-btn')) columnChooserModal.style.display = 'block';
        if (event.target.closest('#refresh-btn')) fetchContacts();

        if (contactsContainer.contains(event.target)) {
            const sortLink = event.target.closest('.sort-link');
            if (sortLink) {
                event.preventDefault();
                const column = sortLink.dataset.sort;
                if (contactsState.sort_by === column) {
                    contactsState.sort_order = contactsState.sort_order === 'asc' ? 'desc' : 'asc';
                } else {
                    contactsState.sort_by = column;
                    contactsState.sort_order = 'asc';
                }
                fetchContacts();
            }

            const paginationLink = event.target.closest('.pagination-link');
            if (paginationLink) {
                event.preventDefault();
                contactsState.page = paginationLink.dataset.page;
                fetchContacts();
            }

            const editButton = event.target.closest('.edit-contact');
            if (editButton) {
                modalTitle.textContent = 'Edit Contact';
                form.action = `{{ url_for('contacts.edit_contact', contact_id=0) }}`.replace('0', editButton.dataset.contactId);
                document.getElementById('first_name').value = editButton.dataset.firstName;
                document.getElementById('last_name').value = editButton.dataset.lastName;
                document.getElementById('email').value = editButton.dataset.email;
                document.getElementById('title').value = editButton.dataset.title;
                document.getElementById('company_account_number').value = editButton.dataset.companyAccountNumber;
                document.getElementById('work_phone').value = editButton.dataset.workPhone;
                document.getElementById('mobile_phone').value = editButton.dataset.mobilePhone;
                document.getElementById('employment_type').value = editButton.dataset.employmentType;
                document.getElementById('status').value = editButton.dataset.status;
                document.getElementById('other_emails').value = editButton.dataset.otherEmails;
                document.getElementById('address').value = editButton.dataset.address;
                document.getElementById('notes').value = editButton.dataset.notes;

                populateAssetList(editButton.dataset.companyAccountNumber, editButton.dataset.contactId);
                contactModal.style.display = 'block';
            }
        }
    });

    contactsContainer.addEventListener('change', function(event) {
        if (event.target.id === 'per_page') {
            contactsState.per_page = event.target.value;
            contactsState.page = 1;
            fetchContacts();
        }
    });

    // Initial load of the table data
    fetchContacts();
});
</script>
{% endblock %}
