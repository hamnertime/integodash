{# hamnertime/integodash/integodash-b7a03f16877fb4e6590039b6f2c0b632176ef6cd/templates/contacts.html #}
{% extends "layout.html" %}
{% block title %}Contacts{% endblock %}

{% block content %}
<h1>All Contacts</h1>

<div class="billing-controls">
    <div class="export-section">
        <button class="button" id="add-contact-btn">Add New Contact</button>
    </div>
    <div class="search-clients">
        <input type="text" id="contact-search" placeholder="Search contacts...">
    </div>
</div>

<table class="client-table">
    <thead>
        <tr>
            <th><a href="#" class="sort-link" data-sort="name">Name<span class="sort-arrow"></span></a></th>
            <th><a href="#" class="sort-link" data-sort="email">Email<span class="sort-arrow"></span></a></th>
            <th><a href="#" class="sort-link" data-sort="company">Company<span class="sort-arrow"></span></a></th>
            <th><a href="#" class="sort-link" data-sort="work_phone">Work Phone<span class="sort-arrow"></span></a></th>
            <th><a href="#" class="sort-link" data-sort="mobile_phone">Mobile Phone<span class="sort-arrow"></span></a></th>
            <th><a href="#" class="sort-link" data-sort="status">Status<span class="sort-arrow"></span></a></th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody id="contact-table-body">
        {% for contact in contacts %}
        <tr>
            <td data-sort-value="{{ contact.first_name }} {{ contact.last_name }}">{{ contact.first_name }} {{ contact.last_name }}</td>
            <td data-sort-value="{{ contact.email }}">{{ contact.email }}</td>
            <td data-sort-value="{{ contact.company_name }}">{{ contact.company_name }}</td>
            <td data-sort-value="{{ contact.work_phone }}">{{ contact.work_phone }}</td>
            <td data-sort-value="{{ contact.mobile_phone }}">{{ contact.mobile_phone }}</td>
            <td data-sort-value="{{ contact.status }}">{{ contact.status }}</td>
            <td>
                <button class="icon-button edit edit-contact"
                    data-contact-id="{{ contact.id }}"
                    data-first-name="{{ contact.first_name }}"
                    data-last-name="{{ contact.last_name }}"
                    data-email="{{ contact.email }}"
                    data-title="{{ contact.title }}"
                    data-company-account-number="{{ contact.company_account_number }}"
                    data-work-phone="{{ contact.work_phone }}"
                    data-mobile-phone="{{ contact.mobile_phone }}"
                    data-employment-type="{{ contact.employment_type }}"
                    data-status="{{ contact.status }}"
                    data-other-emails="{{ contact.other_emails }}"
                    data-address="{{ contact.address }}"
                    data-notes="{{ contact.notes }}">
                    <svg viewBox="0 0 24 24"><path d="M20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18,2.9 17.35,2.9 16.96,3.29L15.13,5.12L18.88,8.87M3,17.25V21H6.75L17.81,9.94L14.06,6.19L3,17.25Z" /></svg>
                </button>
                <a href="{{ url_for('delete_contact', contact_id=contact.id) }}" class="icon-button delete" onclick="return confirm('Are you sure?')">
                    <svg viewBox="0 0 24 24"><path d="M9,3V4H4V6H5V19C5,20.1 5.9,21 7,21H17C18.1,21 19,20.1 19,19V6H20V4H15V3H9M7,6H17V19H7V6M9,8V17H11V8H9M13,8V17H15V8H13Z" /></svg>
                </a>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<div id="contactModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="contactModalTitle">Add New Contact</h2>
            <span class="close-button">&times;</span>
        </div>
        <form id="contactForm" method="POST">
            <div class="form-row">
                <div>
                    <label for="first_name">First Name</label>
                    <input type="text" id="first_name" name="first_name" required>
                </div>
                <div>
                    <label for="last_name">Last Name</label>
                    <input type="text" id="last_name" name="last_name" required>
                </div>
            </div>
            <div class="form-row">
                <div>
                    <label for="email">Email</label>
                    <input type="email" id="email" name="email">
                </div>
                <div>
                    <label for="title">Title</label>
                    <input type="text" id="title" name="title">
                </div>
            </div>
            <div class="form-row">
                <div>
                    <label for="company_account_number">Company</label>
                    <select id="company_account_number" name="company_account_number">
                        {% for company in companies %}
                        <option value="{{ company.account_number }}">{{ company.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label for="work_phone">Work Phone</label>
                    <input type="text" id="work_phone" name="work_phone">
                </div>
            </div>
            <div class="form-row">
                <div>
                    <label for="mobile_phone">Mobile Phone</label>
                    <input type="text" id="mobile_phone" name="mobile_phone">
                </div>
                <div>
                    <label for="employment_type">Employment Type</label>
                    <select id="employment_type" name="employment_type">
                        <option value="Full Time">Full Time</option>
                        <option value="Part Time">Part Time</option>
                    </select>
                </div>
            </div>
            <div class="form-row">
                <div>
                    <label for="status">Status</label>
                    <select id="status" name="status">
                        <option value="Active">Active</option>
                        <option value="Inactive">Inactive</option>
                    </select>
                </div>
                <div>
                    <label for="other_emails">Other Emails</label>
                    <input type="text" id="other_emails" name="other_emails">
                </div>
            </div>
            <div>
                <label for="address">Address</label>
                <textarea id="address" name="address" rows="3"></textarea>
            </div>
            <div>
                <label for="notes">Notes</label>
                <textarea id="notes" name="notes" rows="3"></textarea>
            </div>
            <div class="button-container">
                <button type="submit">Save Contact</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const contactSearch = document.getElementById('contact-search');
    if(contactSearch) {
        contactSearch.addEventListener('input', function() {
            const searchQuery = this.value.toLowerCase();
            const tableBody = document.getElementById('contact-table-body');
            const rows = tableBody.getElementsByTagName('tr');
            for (let i = 0; i < rows.length; i++) {
                const cells = rows[i].getElementsByTagName('td');
                let rowVisible = false;
                if (cells.length > 0) {
                    const contactName = cells[0].textContent.toLowerCase();
                    const contactEmail = cells[1].textContent.toLowerCase();
                    const companyName = cells[2].textContent.toLowerCase();
                    if (contactName.includes(searchQuery) || contactEmail.includes(searchQuery) || companyName.includes(searchQuery)) {
                        rowVisible = true;
                    }
                }
                rows[i].style.display = rowVisible ? '' : 'none';
            }
        });
    }

    const modal = document.getElementById('contactModal');
    const btn = document.getElementById('add-contact-btn');
    const span = document.getElementsByClassName('close-button')[0];
    const form = document.getElementById('contactForm');
    const modalTitle = document.getElementById('contactModalTitle');

    btn.onclick = function() {
        modalTitle.textContent = 'Add New Contact';
        form.action = "{{ url_for('add_contact') }}";
        form.reset();
        modal.style.display = 'block';
    }

    span.onclick = function() {
        modal.style.display = 'none';
    }

    window.onclick = function(event) {
        if (event.target == modal) {
            modal.style.display = 'none';
        }
    }

    document.querySelectorAll('.edit-contact').forEach(button => {
        button.addEventListener('click', function() {
            modalTitle.textContent = 'Edit Contact';
            form.action = `/contacts/edit/${this.dataset.contactId}`;
            document.getElementById('first_name').value = this.dataset.firstName;
            document.getElementById('last_name').value = this.dataset.lastName;
            document.getElementById('email').value = this.dataset.email;
            document.getElementById('title').value = this.dataset.title;
            document.getElementById('company_account_number').value = this.dataset.companyAccountNumber;
            document.getElementById('work_phone').value = this.dataset.workPhone;
            document.getElementById('mobile_phone').value = this.dataset.mobilePhone;
            document.getElementById('employment_type').value = this.dataset.employmentType;
            document.getElementById('status').value = this.dataset.status;
            document.getElementById('other_emails').value = this.dataset.otherEmails;
            document.getElementById('address').value = this.dataset.address;
            document.getElementById('notes').value = this.dataset.notes;
            modal.style.display = 'block';
        });
    });

    let currentSort = { column: 'name', order: 'asc' };

    document.querySelectorAll('.sort-link').forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const column = this.dataset.sort;
            let order = 'asc';
            if (currentSort.column === column && currentSort.order === 'asc') {
                order = 'desc';
            }
            currentSort = { column, order };
            sortTable(column, order);
            updateSortArrows();
        });
    });

    function sortTable(column, order) {
        const tableBody = document.getElementById('contact-table-body');
        const rows = Array.from(tableBody.getElementsByTagName('tr'));

        rows.sort((a, b) => {
            const aVal = a.cells[getColumnIndex(column)].dataset.sortValue;
            const bVal = b.cells[getColumnIndex(column)].dataset.sortValue;

            const isNumeric = !isNaN(parseFloat(aVal)) && isFinite(aVal);

            let comparison = 0;
            if (isNumeric) {
                comparison = parseFloat(aVal) - parseFloat(bVal);
            } else {
                comparison = aVal.localeCompare(bVal);
            }

            return order === 'asc' ? comparison : -comparison;
        });

        rows.forEach(row => tableBody.appendChild(row));
    }

    function getColumnIndex(columnName) {
        const headers = document.querySelectorAll('.client-table th');
        for (let i = 0; i < headers.length; i++) {
            const link = headers[i].querySelector('.sort-link');
            if (link && link.dataset.sort === columnName) {
                return i;
            }
        }
        return 0;
    }

    function updateSortArrows() {
        document.querySelectorAll('.sort-arrow').forEach(arrow => {
            arrow.textContent = '';
        });
        const activeLink = document.querySelector(`.sort-link[data-sort="${currentSort.column}"]`);
        if (activeLink) {
            const arrow = activeLink.querySelector('.sort-arrow');
            arrow.textContent = currentSort.order === 'asc' ? '▲' : '▼';
        }
    }
    sortTable(currentSort.column, currentSort.order);
    updateSortArrows();
});
</script>
{% endblock %}
