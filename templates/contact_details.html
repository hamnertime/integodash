{% extends "layout.html" %}
{% block title %}Contact: {{ contact.first_name }} {{ contact.last_name }}{% endblock %}

{% block head %}
<style>
    #associated-assets-list {
        max-height: 300px;
        overflow-y: auto;
        border: 1px solid var(--input-border);
        padding: 10px;
        border-radius: 4px;
        background-color: var(--background-color);
    }
    #associated-assets-list label {
        display: block;
        margin-bottom: 5px;
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1>{{ contact.first_name }} {{ contact.last_name }}</h1>
    <button id="restore-layout-btn" class="button">Restore Default Layout</button>
</div>

<form id="contact-details-form" method="POST" action="{{ url_for('contacts.contact_details', contact_id=contact.id) }}">
<input type="hidden" name="action" value="save_details">
<div class="grid-stack">
    <div class="grid-stack-item" gs-id="contact-info-widget" gs-w="7" gs-h="6">
        <div class="grid-stack-item-content form-section">
            <div class="grid-stack-item-header">
                <h2>Contact Information</h2>
            </div>
            <div class="form-row">
                <div>
                    <label for="first_name">First Name</label>
                    <input type="text" id="first_name" name="first_name" value="{{ contact.first_name }}" required>
                </div>
                <div>
                    <label for="last_name">Last Name</label>
                    <input type="text" id="last_name" name="last_name" value="{{ contact.last_name }}" required>
                </div>
            </div>
            <div class="form-row">
                <div>
                    <label for="email">Primary Email</label>
                    <input type="email" id="email" name="email" value="{{ contact.email }}">
                </div>
                <div>
                    <label for="title">Title</label>
                    <input type="text" id="title" name="title" value="{{ contact.title }}">
                </div>
            </div>
            <div class="form-row">
                <div>
                    <label for="company_account_number">Company</label>
                    <input type="text" value="{{ contact.company_name }}" readonly>
                    <input type="hidden" name="company_account_number" value="{{ contact.company_account_number }}">
                </div>
                 <div>
                    <label for="status">Status</label>
                    <select id="status" name="status">
                        <option value="Active" {% if contact.status == 'Active' %}selected{% endif %}>Active</option>
                        <option value="Inactive" {% if contact.status == 'Inactive' %}selected{% endif %}>Inactive</option>
                    </select>
                </div>
            </div>
            <div class="form-row">
                <div>
                    <label for="work_phone">Work Phone</label>
                    <input type="text" id="work_phone" name="work_phone" value="{{ contact.work_phone }}">
                </div>
                <div>
                    <label for="mobile_phone">Mobile Phone</label>
                    <input type="text" id="mobile_phone" name="mobile_phone" value="{{ contact.mobile_phone }}">
                </div>
            </div>
             <div class="form-row">
                <div>
                    <label for="employment_type">Employment Type</label>
                    <select id="employment_type" name="employment_type">
                        <option value="Full Time" {% if contact.employment_type == 'Full Time' %}selected{% endif %}>Full Time</option>
                        <option value="Part Time" {% if contact.employment_type == 'Part Time' %}selected{% endif %}>Part Time</option>
                    </select>
                </div>
                <div>
                    <label for="other_emails">Other Emails (comma-separated)</label>
                    <input type="text" id="other_emails" name="other_emails" value="{{ contact.other_emails }}">
                </div>
            </div>
            <div>
                <label for="address">Address</label>
                <textarea id="address" name="address" rows="2">{{ contact.address }}</textarea>
            </div>
            <div>
                <label for="notes">General Notes</label>
                <textarea id="notes" name="notes" rows="2">{{ contact.notes }}</textarea>
            </div>
        </div>
    </div>

    <div class="grid-stack-item" gs-id="associated-assets-widget" gs-x="7" gs-w="5" gs-h="6">
        <div class="grid-stack-item-content">
            <div class="grid-stack-item-header">
                <h2>Associated Assets</h2>
            </div>
            <div id="associated-assets-list">
                {% for asset in company_assets %}
                <label>
                    <input type="checkbox" name="linked_assets" value="{{ asset.id }}" {% if asset.id in linked_assets %}checked{% endif %}>
                    {{ asset.hostname }}
                </label>
                {% else %}
                <p>No assets found for {{ contact.company_name }}.</p>
                {% endfor %}
            </div>
        </div>
    </div>

    <div class="grid-stack-item" gs-id="contact-notes-widget" gs-y="6" gs-w="12" gs-h="4">
        <div class="grid-stack-item-content">
             <div class="grid-stack-item-header">
                <h2>Contact Notes</h2>
            </div>
            <textarea name="note_content" rows="3" placeholder="Add a new note for this contact..." style="width: 100%;"></textarea>
            <div class="button-container">
                <button type="submit" name="action" value="add_note">Add Note</button>
            </div>
            <hr>
            <div id="notes-list" style="max-height: 200px; overflow-y: auto;">
                {% for note in notes %}
                    <div class="note">
                        <div>{{ note.note_content | markdown | safe }}</div>
                        <p class="note-meta">
                            <span>Added by {{ note.author }} on {{ note.created_at | humanize }}</span>
                        </p>
                    </div>
                {% else %}
                    <p>No notes for this contact yet.</p>
                {% endfor %}
            </div>
        </div>
    </div>

</div>
</form>

<div id="save-fab-container" class="fab-container">
    <button id="save-fab" class="button">Save All Changes</button>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function () {
    initializeGrid(
        'contact_details',
        {{ layout|tojson|safe }},
        {{ default_layout|tojson|safe }}
    );

    const mainForm = document.getElementById('contact-details-form');
    const fabContainer = document.getElementById('save-fab-container');
    const saveFab = document.getElementById('save-fab');
    let isDirty = false;

    function handleFormChange() {
        if (!isDirty) {
            isDirty = true;
            fabContainer.classList.add('visible');
        }
    }

    mainForm.addEventListener('input', handleFormChange);
    mainForm.addEventListener('change', handleFormChange);

    saveFab.addEventListener('click', () => {
        // Set the hidden action input's value only when the FAB is clicked
        mainForm.querySelector('input[name="action"]').value = 'save_details';
        mainForm.submit();
    });
});
</script>
{% endblock %}
