{% extends "layout.html" %}
{% block title %}Settings & Sync{% endblock %}

{% block head %}
<style>
    h1, h2 { border-bottom: 2px solid var(--primary-color); padding-bottom: 10px; margin-bottom: 20px; }
    .plan-group, .form-section { margin-bottom: 40px; padding: 20px; background-color: var(--card-bg); border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .plan-group-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
    .plan-group-header h3 { margin: 0; border: none; }
    .plan-table { width: 100%; border-collapse: collapse; }
    .plan-table th, .plan-table td { text-align: left; padding: 12px; border-bottom: 1px solid var(--table-border-color); }
    .plan-table th { font-weight: 600; background-color: var(--table-header-bg); }
    .plan-table input[type="number"], .plan-table select { width: 120px; padding: 8px; border-radius: 4px; border: 1px solid var(--input-border); background-color: var(--input-bg); color: var(--text-color); }
    .plan-table td:first-child { font-weight: 500; }
    .action-cell { text-align: right !important; }
    .add-plan-form { margin-top: 30px; padding-top: 20px; }
    .add-plan-form.full-width { display: flex; gap: 10px; align-items: center; }
    .add-plan-form.full-width input { flex-grow: 1; }
    .add-plan-form input[type="text"], .add-plan-form input[type="url"], .add-plan-form input[type="number"] { padding: 8px; border-radius: 4px; border: 1px solid var(--input-border); background-color: var(--input-bg); color: var(--text-color); margin-right: 10px; }
    .button, button { padding: 10px 20px; background-color: var(--primary-color); color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 1em; text-decoration: none; display: inline-block; }
    .button.secondary { background-color: #6c757d; }
    .button.danger { background-color: #dc3545; }

    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
    .modal-content { background-color: var(--card-bg); margin: 5% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 500px; border-radius: 8px; color: var(--text-color); }
    .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--table-border-color); padding-bottom: 10px; margin-bottom: 15px; }
    #log-content { white-space: pre-wrap; background-color: #2a2a40; color: #e0e0ff; padding: 15px; border-radius: 5px; max-height: 60vh; overflow-y: auto; font-family: 'Courier New', Courier, monospace; }
    .close-button { color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; }
    .close-button:hover { color: var(--text-color); }
    .feature-options-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
    .feature-type-card { background-color: var(--card-bg); padding: 15px; border-radius: 8px; border: 1px solid var(--table-border-color); }
    .feature-type-card h4 { display: flex; justify-content: space-between; align-items: center; margin-top: 0; }
    .icon-button { background: none; border: none; cursor: pointer; padding: 5px; vertical-align: middle; }
    .icon-button svg { width: 20px; height: 20px; }
    .icon-button.edit svg { fill: var(--primary-color); }
    .icon-button.delete svg { fill: #dc3545; }
</style>
{% endblock %}

{% block content %}
    <h1>Settings & Sync</h1>

    <div class="form-section">
        <h2>Import / Export Settings</h2>
        <p>You can export all default billing plans and client-specific overrides to a single JSON file. This is useful for backups or migrating to a new instance. Importing will overwrite all existing settings.</p>
        <div style="display: flex; gap: 20px; margin-top: 20px;">
            <a href="{{ url_for('export_settings') }}" class="button">Export All Settings</a>
            <form action="{{ url_for('import_settings') }}" method="post" enctype="multipart/form-data" onsubmit="return confirm('Are you sure you want to import settings? This will overwrite all existing billing plans and client overrides.');">
                <input type="file" name="file" accept=".json" required>
                <button type="submit" class="button danger">Import Settings</button>
            </form>
        </div>
    </div>

    <div class="form-section">
        <h2>Automated Sync Scheduler</h2>
        <p>Configure and monitor the background data sync jobs. <strong>Note:</strong> You must restart the application for changes to interval or enabled status to take effect.</p>
        <table class="plan-table">
            <thead>
                <tr>
                    <th style="text-align: left;">Job Name</th>
                    <th>Schedule (minutes)</th>
                    <th>Enabled</th>
                    <th>Last Run</th>
                    <th>Status</th>
                    <th class="action-cell">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for job in scheduler_jobs %}
                <tr>
                    <td style="text-align: left;">{{ job.job_name }}</td>
                    <form action="{{ url_for('update_scheduler_job', job_id=job.id) }}" method="post" style="display: contents;">
                        <td><input type="number" name="interval_minutes" value="{{ job.interval_minutes }}" style="width: 80px; text-align: center;"></td>
                        <td><input type="checkbox" name="enabled" {% if job.enabled %}checked{% endif %} onchange="this.form.submit()"></td>
                    </form>
                    <td>{{ job.last_run or 'Never' }}</td>
                    <td style="font-weight: bold; color: {{ 'green' if job.last_status == 'Success' else '#dc3545' }}">{{ job.last_status or 'N/A' }}</td>
                    <td class="action-cell">
                        <form action="{{ url_for('run_now', job_id=job.id) }}" method="post" style="display:inline-block; margin-right: 10px;">
                            <button type="submit">Run Now</button>
                        </form>
                        <a class="button view-log" data-job-id="{{ job.id }}" data-job-name="{{ job.job_name }}">View Log</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="form-section">
        <h2>Application Users & Auditing</h2>
        <a href="{{ url_for('view_audit_log') }}" class="button">View Full Audit Log</a>
        <table class="plan-table" style="margin-top: 20px;">
            <thead><tr><th>Username</th><th class="action-cell">Actions</th></tr></thead>
            <tbody>
                {% for user in app_users %}
                <tr>
                    <td>{{ user.username }}</td>
                    <td class="action-cell">
                        {% if user.id > 1 %}
                        <button class="icon-button edit edit-user" data-user-id="{{ user.id }}" data-user-name="{{ user.username }}">
                           <svg viewBox="0 0 24 24"><path d="M20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18,2.9 17.35,2.9 16.96,3.29L15.13,5.12L18.88,8.87M3,17.25V21H6.75L17.81,9.94L14.06,6.19L3,17.25Z" /></svg>
                        </button>
                        {% if user.id != session.user_id %}
                        <form action="{{ url_for('delete_user', user_id=user.id) }}" method="POST" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this user?');">
                            <button type="submit" class="icon-button delete">
                                <svg viewBox="0 0 24 24"><path d="M9,3V4H4V6H5V19C5,20.1 5.9,21 7,21H17C18.1,21 19,20.1 19,19V6H20V4H15V3H9M7,6H17V19H7V6M9,8V17H11V8H9M13,8V17H15V8H13Z" /></svg>
                            </button>
                        </form>
                        {% endif %}
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <form method="POST" action="{{ url_for('billing_settings') }}" class="add-plan-form full-width">
            <input type="hidden" name="action" value="add_user">
            <input type="text" name="username" placeholder="Enter username" required>
            <button type="submit">Add User</button>
        </form>
    </div>

    <div class="form-section">
        <h2>Add New Billing Plan</h2>
        <form action="{{ url_for('add_billing_plan') }}" method="POST" class="add-plan-form full-width">
            <input type="text" name="new_plan_name" placeholder="Enter New Plan Name" required>
            <button type="submit">Create Plan</button>
        </form>
    </div>

    <div class="form-section">
        <h2>Default Billing Plan Settings</h2>
        <p>These are the default rates for each billing plan and contract term combination. Client-specific overrides can be set on each client's individual settings page.</p>
        {% for plan_name, plans in grouped_plans.items() %}
        <div class="plan-group">
            <form method="POST" action="{{ url_for('billing_settings_action') }}">
                <input type="hidden" name="plan_name" value="{{ plan_name }}">
                <div class="plan-group-header">
                    <h3>{{ plan_name }}</h3>
                    <div>
                        <button type="submit" name="form_action" value="save">Save Plan</button>
                        <button type="submit" class="button danger" name="form_action" value="delete" onclick="return confirm('Are you sure you want to delete the entire {{ plan_name }} plan and all its terms?');">Delete Plan</button>
                    </div>
                </div>
                <table class="plan-table" style="overflow-x: auto; display: block;">
                    <thead>
                        <tr>
                            <th>Contract Term</th><th>Network Fee ($)</th><th>Per Regular User ($)</th><th>Per Workstation ($)</th>
                            <th>Per Server ($)</th><th>Per VM ($)</th><th>Per Switch ($)</th><th>Per Firewall ($)</th>
                            <th>Per Hour Ticket Cost ($)</th><th>Backup Base (Workstation) ($)</th><th>Backup Base (Server) ($)</th>
                            <th>Backup Included (TB)</th><th>Backup per TB ($)</th>
                            <th>Antivirus</th><th>Email</th><th>Phone System</th><th>SOC</th><th>SAT</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for plan in plans %}
                        <tr>
                            <td>{{ plan.term_length }}</td>
                            <input type="hidden" name="plan_ids" value="{{ plan.id }}">
                            <td><input type="number" step="0.01" name="network_management_fee_{{ plan.id }}" value="{{ '%.2f'|format(plan.network_management_fee) }}"></td>
                            <td><input type="number" step="0.01" name="per_user_cost_{{ plan.id }}" value="{{ '%.2f'|format(plan.per_user_cost) }}"></td>
                            <td><input type="number" step="0.01" name="per_workstation_cost_{{ plan.id }}" value="{{ '%.2f'|format(plan.per_workstation_cost) }}"></td>
                            <td><input type="number" step="0.01" name="per_server_cost_{{ plan.id }}" value="{{ '%.2f'|format(plan.per_server_cost) }}"></td>
                            <td><input type="number" step="0.01" name="per_vm_cost_{{ plan.id }}" value="{{ '%.2f'|format(plan.per_vm_cost) }}"></td>
                            <td><input type="number" step="0.01" name="per_switch_cost_{{ plan.id }}" value="{{ '%.2f'|format(plan.per_switch_cost) }}"></td>
                            <td><input type="number" step="0.01" name="per_firewall_cost_{{ plan.id }}" value="{{ '%.2f'|format(plan.per_firewall_cost) }}"></td>
                            <td><input type="number" step="0.01" name="per_hour_ticket_cost_{{ plan.id }}" value="{{ '%.2f'|format(plan.per_hour_ticket_cost) }}"></td>
                            <td><input type="number" step="0.01" name="backup_base_fee_workstation_{{ plan.id }}" value="{{ '%.2f'|format(plan.backup_base_fee_workstation) }}"></td>
                            <td><input type="number" step="0.01" name="backup_base_fee_server_{{ plan.id }}" value="{{ '%.2f'|format(plan.backup_base_fee_server) }}"></td>
                            <td><input type="number" step="0.01" name="backup_included_tb_{{ plan.id }}" value="{{ '%.2f'|format(plan.backup_included_tb) }}"></td>
                            <td><input type="number" step="0.01" name="backup_per_tb_fee_{{ plan.id }}" value="{{ '%.2f'|format(plan.backup_per_tb_fee) }}"></td>
                            <td>
                                <select name="feature_antivirus_{{ plan.id }}">
                                    {% for option in feature_options.antivirus %}
                                    <option value="{{ option.option_name }}" {% if plan.feature_antivirus == option.option_name %}selected{% endif %}>{{ option.option_name }}</option>
                                    {% endfor %}
                                </select>
                            </td>
                            <td>
                                <select name="feature_email_{{ plan.id }}">
                                    {% for option in feature_options.email %}
                                    <option value="{{ option.option_name }}" {% if plan.feature_email == option.option_name %}selected{% endif %}>{{ option.option_name }}</option>
                                    {% endfor %}
                                </select>
                            </td>
                            <td>
                                <select name="feature_phone_{{ plan.id }}">
                                    {% for option in feature_options.phone %}
                                    <option value="{{ option.option_name }}" {% if plan.feature_phone == option.option_name %}selected{% endif %}>{{ option.option_name }}</option>
                                    {% endfor %}
                                </select>
                            </td>
                            <td>
                                 <select name="feature_soc_{{ plan.id }}">
                                    {% for option in feature_options.SOC %}
                                    <option value="{{ option.option_name }}" {% if plan.feature_soc == option.option_name %}selected{% endif %}>{{ option.option_name }}</option>
                                    {% endfor %}
                                </select>
                            </td>
                            <td>
                                <select name="feature_training_{{ plan.id }}">
                                    {% for option in feature_options.SAT %}
                                    <option value="{{ option.option_name }}" {% if plan.feature_training == option.option_name %}selected{% endif %}>{{ option.option_name }}</option>
                                    {% endfor %}
                                </select>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </form>
        </div>
        {% endfor %}
    </div>

    <div class="form-section">
        <h2>Custom Links</h2>
        <table class="plan-table">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>URL</th>
                    <th>Order</th>
                    <th class="action-cell">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for link in custom_links %}
                <tr>
                    <td>{{ link.name }}</td>
                    <td><a href="{{ link.url }}" target="_blank">{{ link.url }}</a></td>
                    <td>{{ link.link_order }}</td>
                    <td class="action-cell">
                        <button class="icon-button edit edit-link" data-link-id="{{ link.id }}" data-link-name="{{ link.name }}" data-link-url="{{ link.url }}" data-link-order="{{ link.link_order }}">
                            <svg viewBox="0 0 24 24"><path d="M20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18,2.9 17.35,2.9 16.96,3.29L15.13,5.12L18.88,8.87M3,17.25V21H6.75L17.81,9.94L14.06,6.19L3,17.25Z" /></svg>
                        </button>
                        <form action="{{ url_for('delete_link', link_id=link.id) }}" method="POST" style="display: inline;">
                            <button type="submit" class="icon-button delete">
                                <svg viewBox="0 0 24 24"><path d="M9,3V4H4V6H5V19C5,20.1 5.9,21 7,21H17C18.1,21 19,20.1 19,19V6H20V4H15V3H9M7,6H17V19H7V6M9,8V17H11V8H9M13,8V17H15V8H13Z" /></svg>
                            </button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <form method="POST" action="{{ url_for('add_link') }}" class="add-plan-form full-width">
            <input type="text" name="name" placeholder="Link Name" required>
            <input type="url" name="url" placeholder="https://example.com" required>
            <input type="number" name="order" placeholder="Order" value="0">
            <button type="submit">Add Link</button>
        </form>
    </div>

    <div class="form-section">
        <h2>Feature Options Management</h2>
        <div class="feature-options-grid">
            {% for feature_type, options in feature_options.items() %}
            <div class="feature-type-card">
                <h4>
                    <span>{{ feature_type|capitalize }}</span>
                    <button class="button add-feature-option" data-feature-type="{{ feature_type }}">Add</button>
                </h4>
                <table class="plan-table">
                    <tbody>
                        {% for option in options %}
                        <tr>
                            <td>{{ option.option_name }}</td>
                            <td class="action-cell">
                                <button class="icon-button edit edit-feature-option" data-option-id="{{ option.id }}" data-option-name="{{ option.option_name }}">
                                    <svg viewBox="0 0 24 24"><path d="M20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18,2.9 17.35,2.9 16.96,3.29L15.13,5.12L18.88,8.87M3,17.25V21H6.75L17.81,9.94L14.06,6.19L3,17.25Z" /></svg>
                                </button>
                                <form action="{{ url_for('delete_feature_option', option_id=option.id) }}" method="POST" onsubmit="return confirm('Are you sure?')" style="display:inline;">
                                    <button type="submit" class="icon-button delete">
                                        <svg viewBox="0 0 24 24"><path d="M9,3V4H4V6H5V19C5,20.1 5.9,21 7,21H17C18.1,21 19,20.1 19,19V6H20V4H15V3H9M7,6H17V19H7V6M9,8V17H11V8H9M13,8V17H15V8H13Z" /></svg>
                                    </button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% endfor %}
        </div>
    </div>

    <div id="logModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Job Log</h2>
                <span class="close-button">&times;</span>
            </div>
            <pre id="log-content">Loading log...</pre>
        </div>
    </div>

    <div id="featureModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="featureModalTitle"></h2>
                <span class="close-button">&times;</span>
            </div>
            <form id="featureModalForm" method="POST">
                <input type="hidden" name="feature_type" id="featureModalType">
                <label for="featureModalName">Option Name:</label>
                <input type="text" name="option_name" id="featureModalName" required style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid var(--input-border); background-color: var(--input-bg); color: var(--text-color);">
                <div style="text-align: right; margin-top: 20px;">
                    <button type="submit" class="button">Save</button>
                </div>
            </form>
        </div>
    </div>

    <div id="linkModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="linkModalTitle">Edit Link</h2>
                <span class="close-button">&times;</span>
            </div>
            <form id="linkModalForm" method="POST">
                <label for="linkModalName">Link Name:</label>
                <input type="text" name="name" id="linkModalName" required style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid var(--input-border); background-color: var(--input-bg); color: var(--text-color); margin-bottom: 10px;">
                <label for="linkModalUrl">URL:</label>
                <input type="url" name="url" id="linkModalUrl" required style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid var(--input-border); background-color: var(--input-bg); color: var(--text-color); margin-bottom: 10px;">
                <label for="linkModalOrder">Order:</label>
                <input type="number" name="order" id="linkModalOrder" required style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid var(--input-border); background-color: var(--input-bg); color: var(--text-color);">
                <div style="text-align: right; margin-top: 20px;">
                    <button type="submit" class="button">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <div id="userModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="userModalTitle">Edit User</h2>
                <span class="close-button">&times;</span>
            </div>
            <form id="userModalForm" method="POST">
                <label for="userModalName">Username:</label>
                <input type="text" name="username" id="userModalName" required style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid var(--input-border); background-color: var(--input-bg); color: var(--text-color);">
                <div style="text-align: right; margin-top: 20px;">
                    <button type="submit" class="button">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const logModal = document.getElementById('logModal');
    const featureModal = document.getElementById('featureModal');
    const linkModal = document.getElementById('linkModal');
    const userModal = document.getElementById('userModal');
    const logContent = document.getElementById('log-content');
    const logModalTitle = logModal.querySelector('.modal-header h2');
    const closeButtons = document.querySelectorAll('.close-button');

    // Generic function to close any modal
    function closeModal() {
        logModal.style.display = 'none';
        featureModal.style.display = 'none';
        linkModal.style.display = 'none';
        userModal.style.display = 'none';
    }

    closeButtons.forEach(button => {
        button.onclick = closeModal;
    });

    window.onclick = (event) => {
        if (event.target == logModal || event.target == featureModal || event.target == linkModal || event.target == userModal) {
            closeModal();
        }
    }

    document.querySelectorAll('.view-log').forEach(button => {
        button.addEventListener('click', function(event) {
            event.preventDefault();
            const jobId = this.dataset.jobId;
            const jobName = this.dataset.jobName;
            logModalTitle.textContent = `Log for: ${jobName}`;
            logContent.textContent = 'Loading log...';
            logModal.style.display = 'block';
            fetch(`/scheduler/log/${jobId}`)
                .then(response => response.ok ? response.json() : Promise.reject(response))
                .then(data => { logContent.textContent = data.log || 'Log is empty or an error occurred.'; })
                .catch(error => { logContent.textContent = 'Failed to load log: ' + error; });
        });
    });

    document.querySelectorAll('.add-feature-option').forEach(button => {
        button.addEventListener('click', function() {
            const featureType = this.dataset.featureType;
            document.getElementById('featureModalTitle').textContent = `Add New ${featureType} Option`;
            document.getElementById('featureModalForm').action = "{{ url_for('add_feature_option') }}";
            document.getElementById('featureModalType').value = featureType;
            document.getElementById('featureModalName').value = '';
            featureModal.style.display = 'block';
        });
    });

    document.querySelectorAll('.edit-feature-option').forEach(button => {
        button.addEventListener('click', function() {
            const optionId = this.dataset.optionId;
            const optionName = this.dataset.optionName;
            document.getElementById('featureModalTitle').textContent = `Edit Option: ${optionName}`;
            document.getElementById('featureModalForm').action = `/settings/features/edit/${optionId}`;
            document.getElementById('featureModalName').value = optionName;
            featureModal.style.display = 'block';
        });
    });

    document.querySelectorAll('.edit-link').forEach(button => {
        button.addEventListener('click', function() {
            const linkId = this.dataset.linkId;
            document.getElementById('linkModalForm').action = `/settings/links/edit/${linkId}`;
            document.getElementById('linkModalName').value = this.dataset.linkName;
            document.getElementById('linkModalUrl').value = this.dataset.linkUrl;
            document.getElementById('linkModalOrder').value = this.dataset.linkOrder;
            linkModal.style.display = 'block';
        });
    });

    document.querySelectorAll('.edit-user').forEach(button => {
        button.addEventListener('click', function() {
            const userId = this.dataset.userId;
            document.getElementById('userModalForm').action = `/settings/user/edit/${userId}`;
            document.getElementById('userModalTitle').textContent = `Edit User: ${this.dataset.userName}`;
            document.getElementById('userModalName').value = this.dataset.userName;
            userModal.style.display = 'block';
        });
    });
});
</script>
{% endblock %}
