{% extends "layout.html" %}
{% block title %}Billing Dashboard{% endblock %}

{% block content %}
<h1>Client Billing Overview</h1>

<div class="export-section">
    <form action="{{ url_for('export_all_bills_zip') }}" method="POST">
        <strong>Export All Invoices for:</strong>
        <select name="month">
            {% for month in month_options %}
                <option value="{{ month.value }}">{{ month.name }}</option>
            {% endfor %}
        </select>
        <input type="number" name="year" value="{{ current_year }}" style="width: 80px;">
        <button type="submit" class="button">Download ZIP</button>
    </form>
</div>

<table class="client-table">
    <thead>
        <tr>
            <th><a href="{{ url_for('billing_dashboard', sort_by='name', sort_order='desc' if sort_by == 'name' and sort_order == 'asc' else 'asc') }}">
                Company Name<span class="sort-arrow">{% if sort_by == 'name' %}{% if sort_order == 'asc' %}▲{% else %}▼{% endif %}{% endif %}</span>
            </a></th>
            <th><a href="{{ url_for('billing_dashboard', sort_by='billing_plan', sort_order='desc' if sort_by == 'billing_plan' and sort_order == 'asc' else 'asc') }}">
                Billing Plan<span class="sort-arrow">{% if sort_by == 'billing_plan' %}{% if sort_order == 'asc' %}▲{% else %}▼{% endif %}{% endif %}</span>
            </a></th>
            <th><a href="{{ url_for('billing_dashboard', sort_by='workstations', sort_order='desc' if sort_by == 'workstations' and sort_order == 'asc' else 'asc') }}">
                Workstations<span class="sort-arrow">{% if sort_by == 'workstations' %}{% if sort_order == 'asc' %}▲{% else %}▼{% endif %}{% endif %}</span>
            </a></th>
            <th><a href="{{ url_for('billing_dashboard', sort_by='servers', sort_order='desc' if sort_by == 'servers' and sort_order == 'asc' else 'asc') }}">
                Servers<span class="sort-arrow">{% if sort_by == 'servers' %}{% if sort_order == 'asc' %}▲{% else %}▼{% endif %}{% endif %}</span>
            </a></th>
            <th><a href="{{ url_for('billing_dashboard', sort_by='vms', sort_order='desc' if sort_by == 'vms' and sort_order == 'asc' else 'asc') }}">
                VMs<span class="sort-arrow">{% if sort_by == 'vms' %}{% if sort_order == 'asc' %}▲{% else %}▼{% endif %}{% endif %}</span>
            </a></th>
            <th><a href="{{ url_for('billing_dashboard', sort_by='regular_users', sort_order='desc' if sort_by == 'regular_users' and sort_order == 'asc' else 'asc') }}">
                Regular Users<span class="sort-arrow">{% if sort_by == 'regular_users' %}{% if sort_order == 'asc' %}▲{% else %}▼{% endif %}{% endif %}</span>
            </a></th>
            <th><a href="{{ url_for('billing_dashboard', sort_by='backup', sort_order='desc' if sort_by == 'backup' and sort_order == 'asc' else 'asc') }}">
                Backup (TB)<span class="sort-arrow">{% if sort_by == 'backup' %}{% if sort_order == 'asc' %}▲{% else %}▼{% endif %}{% endif %}</span>
            </a></th>
            <th><a href="{{ url_for('billing_dashboard', sort_by='hours', sort_order='desc' if sort_by == 'hours' and sort_order == 'asc' else 'asc') }}">
                Hours (This Year)<span class="sort-arrow">{% if sort_by == 'hours' %}{% if sort_order == 'asc' %}▲{% else %}▼{% endif %}{% endif %}</span>
            </a></th>
            <th><a href="{{ url_for('billing_dashboard', sort_by='bill', sort_order='desc' if sort_by == 'bill' and sort_order == 'asc' else 'asc') }}">
                Calculated Bill<span class="sort-arrow">{% if sort_by == 'bill' %}{% if sort_order == 'asc' %}▲{% else %}▼{% endif %}{% endif %}</span>
            </a></th>
        </tr>
    </thead>
    <tbody>
        {% if clients %}
            {% for client in clients %}
            <tr>
                <td><strong><a href="{{ url_for('client_breakdown', account_number=client.account_number) }}">{{ client.name }}</a></strong></td>
                <td>{{ client['billing_plan'] }}</td>
                <td>{{ client['workstations'] }}</td>
                <td>{{ client['servers'] }}</td>
                <td>{{ client['vms'] }}</td>
                <td>{{ client['regular_users'] }}</td>
                <td>{{ "%.2f"|format(client['total_backup_bytes'] / 1099511627776.0) }}</td>
                <td>{{ "%.2f"|format(client['total_hours']) }}</td>
                <td>${{ "%.2f"|format(client['total_bill']) }}</td>
            </tr>
            {% endfor %}
        {% else %}
            <tr>
                <td colspan="9" style="text-align: center;">No clients found in the database. Run sync scripts from the settings page.</td>
            </tr>
        {% endif %}
    </tbody>
</table>
{% endblock %}
