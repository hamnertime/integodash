{% extends "layout.html" %}
{% block title %}Billing Dashboard{% endblock %}

{% block head %}
<style>
    h1 { text-align: center; margin-bottom: 20px; }
    .client-table { width: 100%; border-collapse: collapse; background-color: var(--card-bg); box-shadow: 0 2px 8px rgba(0,0,0,0.1); font-size: 1em; margin-bottom: 20px; }
    .client-table th, .client-table td { border: 1px solid var(--table-border-color); padding: 12px 15px; text-align: left; vertical-align: middle; }
    .client-table th { background-color: var(--table-header-bg); font-weight: 600; }
    .client-table th a { text-decoration: none; color: inherit; display: block; }
    .client-table th a:hover { color: var(--primary-color); }
    .client-table td a { color: inherit; text-decoration: none; }
    .client-table td a:hover { color: var(--primary-color); text-decoration: underline; }
    .client-table tr:nth-child(even) { background-color: var(--background-color); }
    .client-table tr:hover { background-color: var(--table-row-hover-bg); }
    .sort-arrow { margin-left: 5px; }
    .export-section { background-color: var(--card-bg); padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center; }
    .export-section select, .export-section input, .export-section button { padding: 8px; margin: 0 5px; border-radius: 4px; border: 1px solid var(--input-border); background-color: var(--input-bg); color: var(--text-color); }
    .button { padding: 10px 20px; background-color: var(--primary-color); color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 1em; text-decoration: none; display: inline-block; }
</style>
{% endblock %}

{% block content %}
<h1>Client Billing Overview</h1>

<div class="export-section">
    <form action="{{ url_for('export_all_bills_zip') }}" method="POST">
        <strong>Export All Invoices for:</strong>
        <select name="month">
            {% for month in month_options %}
                <option value="{{ month.value }}">{{ month.name }}</option>
            {% endfor %}
        </select>
        <input type="number" name="year" value="{{ current_year }}" style="width: 80px;">
        <button type="submit" class="button">Download ZIP</button>
    </form>
</div>

<table class="client-table">
    <thead>
        <tr>
            <th><a href="{{ url_for('billing_dashboard', sort_by='name', sort_order='desc' if sort_by == 'name' and sort_order == 'asc' else 'asc') }}">
                Company Name<span class="sort-arrow">{% if sort_by == 'name' %}{% if sort_order == 'asc' %}▲{% else %}▼{% endif %}{% endif %}</span>
            </a></th>
            <th><a href="{{ url_for('billing_dashboard', sort_by='billing_plan', sort_order='desc' if sort_by == 'billing_plan' and sort_order == 'asc' else 'asc') }}">
                Billing Plan<span class="sort-arrow">{% if sort_by == 'billing_plan' %}{% if sort_order == 'asc' %}▲{% else %}▼{% endif %}{% endif %}</span>
            </a></th>
            <th><a href="{{ url_for('billing_dashboard', sort_by='workstations', sort_order='desc' if sort_by == 'workstations' and sort_order == 'asc' else 'asc') }}">
                Workstations<span class="sort-arrow">{% if sort_by == 'workstations' %}{% if sort_order == 'asc' %}▲{% else %}▼{% endif %}{% endif %}</span>
            </a></th>
            <th><a href="{{ url_for('billing_dashboard', sort_by='servers', sort_order='desc' if sort_by == 'servers' and sort_order == 'asc' else 'asc') }}">
                Servers<span class="sort-arrow">{% if sort_by == 'servers' %}{% if sort_order == 'asc' %}▲{% else %}▼{% endif %}{% endif %}</span>
            </a></th>
            <th><a href="{{ url_for('billing_dashboard', sort_by='vms', sort_order='desc' if sort_by == 'vms' and sort_order == 'asc' else 'asc') }}">
                VMs<span class="sort-arrow">{% if sort_by == 'vms' %}{% if sort_order == 'asc' %}▲{% else %}▼{% endif %}{% endif %}</span>
            </a></th>
            <th><a href="{{ url_for('billing_dashboard', sort_by='regular_users', sort_order='desc' if sort_by == 'regular_users' and sort_order == 'asc' else 'asc') }}">
                Regular Users<span class="sort-arrow">{% if sort_by == 'regular_users' %}{% if sort_order == 'asc' %}▲{% else %}▼{% endif %}{% endif %}</span>
            </a></th>
            <th><a href="{{ url_for('billing_dashboard', sort_by='backup', sort_order='desc' if sort_by == 'backup' and sort_order == 'asc' else 'asc') }}">
                Backup (TB)<span class="sort-arrow">{% if sort_by == 'backup' %}{% if sort_order == 'asc' %}▲{% else %}▼{% endif %}{% endif %}</span>
            </a></th>
            <th><a href="{{ url_for('billing_dashboard', sort_by='hours', sort_order='desc' if sort_by == 'hours' and sort_order == 'asc' else 'asc') }}">
                Hours (This Year)<span class="sort-arrow">{% if sort_by == 'hours' %}{% if sort_order == 'asc' %}▲{% else %}▼{% endif %}{% endif %}</span>
            </a></th>
            <th><a href="{{ url_for('billing_dashboard', sort_by='bill', sort_order='desc' if sort_by == 'bill' and sort_order == 'asc' else 'asc') }}">
                Calculated Bill<span class="sort-arrow">{% if sort_by == 'bill' %}{% if sort_order == 'asc' %}▲{% else %}▼{% endif %}{% endif %}</span>
            </a></th>
        </tr>
    </thead>
    <tbody>
        {% if clients %}
            {% for client in clients %}
            <tr>
                <td><strong><a href="{{ url_for('client_breakdown', account_number=client.account_number) }}">{{ client.name }}</a></strong></td>
                <td>{{ client['billing_plan'] }}</td>
                <td>{{ client['workstations'] }}</td>
                <td>{{ client['servers'] }}</td>
                <td>{{ client['vms'] }}</td>
                <td>{{ client['regular_users'] }}</td>
                <td>{{ "%.2f"|format(client['total_backup_bytes'] / 1099511627776.0) }}</td>
                <td>{{ "%.2f"|format(client['total_hours']) }}</td>
                <td>${{ "%.2f"|format(client['total_bill']) }}</td>
            </tr>
            {% endfor %}
        {% else %}
            <tr>
                <td colspan="9" style="text-align: center;">No clients found in the database. Run sync scripts from the settings page.</td>
            </tr>
        {% endif %}
    </tbody>
</table>
{% endblock %}
