<div class="grid-stack-item-content">
    <div class="form-section">
        <h2>Add New Billing Plan</h2>
        <form action="{{ url_for('add_billing_plan') }}" method="POST" class="add-plan-form full-width">
            <input type="text" name="new_plan_name" placeholder="Enter New Plan Name" required>
            <button type="submit">Create Plan</button>
        </form>
    </div>

    <div class="form-section">
        <h2>Default Billing Plan Settings</h2>
        <p>These are the default rates for each billing plan and contract term combination. Client-specific overrides can be set on each client's individual settings page.</p>
        {% for plan_name, plans in grouped_plans.items() %}
        <div class="plan-group">
            <form method="POST" action="{{ url_for('billing_settings_action') }}">
                <input type="hidden" name="plan_name" value="{{ plan_name }}">
                <div class="plan-group-header">
                    <h3>{{ plan_name }}</h3>
                    <div>
                        <button type="submit" name="form_action" value="save" class="icon-button save" title="Save Plan">
                            <svg viewBox="0 0 24 24"><path d="M17 3H5C3.89 3 3 3.9 3 5V19C3 20.1 3.89 21 5 21H19C20.1 21 21 20.1 21 19V7L17 3M19 19H5V5H16.17L19 7.83V19M12 12C10.34 12 9 13.34 9 15S10.34 18 12 18 15 16.66 15 15 13.66 12 12 12M6 6H15V10H6V6Z" /></svg>
                        </button>
                        <button type="submit" class="icon-button delete" name="form_action" value="delete" onclick="return confirm('Are you sure you want to delete the entire {{ plan_name }} plan and all its terms?');" title="Delete Plan">
                            <svg viewBox="0 0 24 24"><path d="M9,3V4H4V6H5V19C5,20.1 5.9,21 7,21H17C18.1,21 19,20.1 19,19V6H20V4H15V3H9M7,6H17V19H7V6M9,8V17H11V8H9M13,8V17H15V8H13Z" /></svg>
                        </button>
                    </div>
                </div>
                <table class="plan-table" style="overflow-x: auto; display: block;">
                    <thead>
                        <tr>
                            <th>Contract Term</th>
                            <th>Support Level</th>
                            <th>Per Regular User ($)</th><th>Per Workstation ($)</th>
                            <th>Per Server ($)</th><th>Per VM ($)</th><th>Per Switch ($)</th><th>Per Firewall ($)</th>
                            <th>Per Hour Ticket Cost ($)</th><th>Backup Base (Workstation) ($)</th><th>Backup Base (Server) ($)</th>
                            <th>Backup Included (TB)</th><th>Backup per TB ($)</th>
                            {% for feature_type in feature_types %}
                                <th>{{ feature_type }}</th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for plan in plans %}
                        <tr>
                            <td>{{ plan.term_length }}</td>
                            <input type="hidden" name="plan_ids" value="{{ plan.id }}">
                            <td>
                                <select name="support_level_{{ plan.id }}">
                                    <option value="Billed Hourly" {% if plan.support_level == 'Billed Hourly' %}selected{% endif %}>Billed Hourly</option>
                                    <option value="Unlimited" {% if plan.support_level == 'Unlimited' %}selected{% endif %}>Unlimited</option>
                                </select>
                            </td>
                            <td><input type="number" step="0.01" name="per_user_cost_{{ plan.id }}" value="{{ '%.2f'|format(plan.per_user_cost) }}"></td>
                            <td><input type="number" step="0.01" name="per_workstation_cost_{{ plan.id }}" value="{{ '%.2f'|format(plan.per_workstation_cost) }}"></td>
                            <td><input type="number" step="0.01" name="per_server_cost_{{ plan.id }}" value="{{ '%.2f'|format(plan.per_server_cost) }}"></td>
                            <td><input type="number" step="0.01" name="per_vm_cost_{{ plan.id }}" value="{{ '%.2f'|format(plan.per_vm_cost) }}"></td>
                            <td><input type="number" step="0.01" name="per_switch_cost_{{ plan.id }}" value="{{ '%.2f'|format(plan.per_switch_cost) }}"></td>
                            <td><input type="number" step="0.01" name="per_firewall_cost_{{ plan.id }}" value="{{ '%.2f'|format(plan.per_firewall_cost) }}"></td>
                            <td><input type="number" step="0.01" name="per_hour_ticket_cost_{{ plan.id }}" value="{{ '%.2f'|format(plan.per_hour_ticket_cost) }}"></td>
                            <td><input type="number" step="0.01" name="backup_base_fee_workstation_{{ plan.id }}" value="{{ '%.2f'|format(plan.backup_base_fee_workstation) }}"></td>
                            <td><input type="number" step="0.01" name="backup_base_fee_server_{{ plan.id }}" value="{{ '%.2f'|format(plan.backup_base_fee_server) }}"></td>
                            <td><input type="number" step="0.01" name="backup_included_tb_{{ plan.id }}" value="{{ '%.2f'|format(plan.backup_included_tb) }}"></td>
                            <td><input type="number" step="0.01" name="backup_per_tb_fee_{{ plan.id }}" value="{{ '%.2f'|format(plan.backup_per_tb_fee) }}"></td>
                            {% for feature_type in feature_types %}
                            <td>
                                <select name="feature_{{ feature_type.lower().replace(' ', '_') }}_{{ plan.id }}">
                                    {% for option in feature_options[feature_type] %}
                                    <option value="{{ option.option_name }}" {% if plan['feature_' + feature_type.lower().replace(' ', '_')] == option.option_name %}selected{% endif %}>{{ option.option_name }}</option>
                                    {% endfor %}
                                </select>
                            </td>
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </form>
        </div>
        {% endfor %}
    </div>
</div>