<div class="grid-stack-item-content form-section">
    <h2>Billing Rate Overrides</h2>
    <form method="POST" action="{{ url_for('client_settings', account_number=client.account_number) }}">
        <div class="form-grid">
            <div></div> <div class="header default">Default Value</div>
            <div class="header override">Override Value</div>
            <div class="header">Enable</div>

            {% macro plan_override_input(name, label, short_name, all_plans) %}
                <label for="{{ name }}">{{ label }}</label>
                <input type="text" value="{{ client.billing_plan or 'N/A' }}" disabled>
                <select name="{{ name }}" id="{{ name }}">
                     <option value="">-- No Override --</option>
                     {% for plan in all_plans %}
                         <option value="{{ plan.billing_plan }}" {% if overrides and name in overrides and overrides[name] == plan.billing_plan %}selected{% endif %}>{{ plan.billing_plan }}</option>
                     {% endfor %}
                </select>
                <input type="checkbox" name="override_{{ short_name }}_enabled" {% if overrides and ('override_' + short_name + '_enabled') in overrides and overrides['override_' + short_name + '_enabled'] %}checked{% endif %} title="Enable Override">
            {% endmacro %}

            {% macro rate_input(name, label, short_name, type='currency', step='0.01') %}
                <label for="{{ name }}">{{ label }}</label>
                {% if type == 'text' %}
                    <input type="text" value="{{ defaults[name] if defaults and name in defaults.keys() and defaults[name] is not none else 'N/A' }}" disabled>
                    <select name="{{ name }}" id="{{ name }}">
                         <option value="">-- No Override --</option>
                         <option value="Billed Hourly" {% if overrides and name in overrides and overrides[name] == 'Billed Hourly' %}selected{% endif %}>Billed Hourly</option>
                         <option value="Unlimited" {% if overrides and name in overrides and overrides[name] == 'Unlimited' %}selected{% endif %}>Unlimited</option>
                    </select>
                {% elif type == 'number' %}
                     <input type="text" value="{{ defaults[name] if defaults and name in defaults.keys() and defaults[name] is not none else '0' }}" disabled>
                     <input type="number" step="{{ step }}" name="{{ name }}" id="{{ name }}" value="{{ overrides[name] if overrides and name in overrides and overrides[name] is not none }}">
                {% else %}
                    <input type="text" value="${{ '%.2f'|format(defaults[name]|float) if defaults and name in defaults.keys() and defaults[name] is not none else 'N/A' }}" disabled>
                    <input type="number" step="{{ step }}" name="{{ name }}" id="{{ name }}" value="{{ overrides[name] if overrides and name in overrides and overrides[name] is not none }}">
                {% endif %}
                <input type="checkbox" name="override_{{ short_name }}_enabled" {% if overrides and ('override_' + short_name + '_enabled') in overrides and overrides['override_' + short_name + '_enabled'] %}checked{% endif %} title="Enable Override">
            {% endmacro %}

            {{ plan_override_input('billing_plan', 'Assigned Plan', 'billing_plan', all_billing_plans) }}
            {{ rate_input('support_level', 'Support Level', 'support_level', type='text') }}
            {{ rate_input('per_user_cost', 'Per Regular User Cost', 'puc') }}
            {{ rate_input('per_workstation_cost', 'Per Workstation Cost', 'pwc') }}
            {{ rate_input('per_server_cost', 'Per Server Cost', 'psc') }}
            {{ rate_input('per_vm_cost', 'Per VM Cost', 'pvc') }}
            {{ rate_input('per_switch_cost', 'Per Switch Cost', 'pswitchc') }}
            {{ rate_input('per_firewall_cost', 'Per Firewall Cost', 'pfirewallc') }}
            {{ rate_input('per_hour_ticket_cost', 'Per Hour Ticket Cost', 'phtc')}}
            {{ rate_input('backup_base_fee_workstation', 'Backup Base (Workstation)', 'bbfw') }}
            {{ rate_input('backup_base_fee_server', 'Backup Base (Server)', 'bbfs') }}
            {{ rate_input('backup_included_tb', 'Backup Included (TB)', 'bit', type='number') }}
            {{ rate_input('backup_per_tb_fee', 'Backup per TB Fee', 'bpt') }}
            {{ rate_input('prepaid_hours_monthly', 'Pre-paid Hours (Monthly)', 'prepaid_hours_monthly', type='number', step='1') }}
            {{ rate_input('prepaid_hours_yearly', 'Pre-paid Hours (Yearly)', 'prepaid_hours_yearly', type='number', step='1') }}
        </div>
        <div class="button-container">
            <button type="submit" name="action" value="save_overrides">Save All Overrides</button>
        </div>
    </form>
</div>
